import 'package:flutter/material.dart';
import 'package:go_router/go_router.dart';
import 'package:gogreen_admin/models/service_detail.dart';
import 'package:gogreen_admin/models/customer_info.dart';
import 'package:gogreen_admin/models/vehicle_info.dart';
import 'package:gogreen_admin/models/service_item.dart';
import 'package:gogreen_admin/widgets/responsive_layout.dart';
import 'package:gogreen_admin/theme/app_colors.dart';

class ServiceDetailsPage extends StatefulWidget {
  final String serviceId;

  const ServiceDetailsPage({
    super.key,
    required this.serviceId,
  });

  @override
  State<ServiceDetailsPage> createState() => _ServiceDetailsPageState();
}

class _ServiceDetailsPageState extends State<ServiceDetailsPage> {
  late ServiceDetail _serviceDetail;
  bool _isLoading = true;
  String _customerNotes = '';

  @override
  void initState() {
    super.initState();
    _loadServiceDetail();
  }

  Future<void> _loadServiceDetail() async {
    setState(() => _isLoading = true);
    
    // TODO: Load from Supabase
    // For now, create mock data
    await Future.delayed(const Duration(milliseconds: 500));
    
    setState(() {
      _serviceDetail = ServiceDetail(
        id: widget.serviceId,
        kanbanCardId: widget.serviceId,
        customer: CustomerInfo(
          name: 'GG Protech',
          phone: '0000000000',
          email: 'fleet@example.com',
          date: DateTime.now(),
          gstNumber: null,
        ),
        vehicle: VehicleInfo(
          registrationNumber: 'MH15JC0060',
          makeAndModel: 'TATA TIGOR XPRESS-T XM',
          year: 2020,
          fuelType: 'EV',
        ),
        periodicServiceItems: ServiceDetail.getDefaultPeriodicItems('EV'),
        bodyshopItems: [],
        customerNotes: '',
      );
      _isLoading = false;
    });
  }

  void _editCustomer() {
    showDialog(
      context: context,
      builder: (context) => _EditCustomerDialog(
        customer: _serviceDetail.customer,
        onSave: (updatedCustomer) {
          setState(() {
            _serviceDetail = _serviceDetail.copyWith(customer: updatedCustomer);
          });
          ScaffoldMessenger.of(context).showSnackBar(
            const SnackBar(content: Text('Customer information updated')),
          );
        },
      ),
    );
  }

  void _editVehicle() {
    showDialog(
      context: context,
      builder: (context) => _EditVehicleDialog(
        vehicle: _serviceDetail.vehicle,
        onSave: (updatedVehicle) {
          setState(() {
            _serviceDetail = _serviceDetail.copyWith(vehicle: updatedVehicle);
            // Update periodic items based on new fuel type
            if (updatedVehicle.fuelType != _serviceDetail.vehicle.fuelType) {
              _serviceDetail = _serviceDetail.copyWith(
                periodicServiceItems: ServiceDetail.getDefaultPeriodicItems(updatedVehicle.fuelType),
              );
            }
          });
          ScaffoldMessenger.of(context).showSnackBar(
            const SnackBar(content: Text('Vehicle information updated')),
          );
        },
      ),
    );
  }

  void _generateEstimate() {
    // Show estimate preview dialog
    showDialog(
      context: context,
      builder: (context) => _EstimatePreviewDialog(
        serviceDetail: _serviceDetail,
      ),
    );
  }

  void _generateReceipt() {
    // Show receipt preview dialog
    showDialog(
      context: context,
      builder: (context) => _ReceiptPreviewDialog(
        serviceDetail: _serviceDetail,
      ),
    );
  }

  void _openInventoryMaker() {
    // Show inventory maker dialog
    showDialog(
      context: context,
      builder: (context) => _InventoryMakerDialog(
        serviceDetail: _serviceDetail,
      ),
    );
  }

  void _processPayment() {
    // Show payment processing dialog
    showDialog(
      context: context,
      builder: (context) => _PaymentDialog(
        totalAmount: _serviceDetail.grandTotal,
        onPaymentComplete: () {
          ScaffoldMessenger.of(context).showSnackBar(
            const SnackBar(content: Text('Payment processed successfully')),
          );
        },
      ),
    );
  }

  void _deleteInteraction() {
    // Show confirmation dialog
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        title: const Text('Delete Interaction'),
        content: const Text('Are you sure you want to delete this service interaction? This action cannot be undone.'),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: const Text('Cancel'),
          ),
          ElevatedButton(
            onPressed: () {
              Navigator.pop(context);
              // TODO: Delete from database
              context.go('/dashboard');
              ScaffoldMessenger.of(context).showSnackBar(
                const SnackBar(content: Text('Service interaction deleted')),
              );
            },
            style: ElevatedButton.styleFrom(
              backgroundColor: const Color(0xFFEF4444),
              foregroundColor: Colors.white,
            ),
            child: const Text('Delete'),
          ),
        ],
      ),
    );
  }

  void _addPeriodicItem() {
    showDialog(
      context: context,
      builder: (context) => _AddServiceItemDialog(
        onAdd: (item) {
          setState(() {
            _serviceDetail = _serviceDetail.copyWith(
              periodicServiceItems: [..._serviceDetail.periodicServiceItems, item],
            );
          });
        },
        itemType: 'periodic',
      ),
    );
  }

  void _addBodyshopItem() {
    showDialog(
      context: context,
      builder: (context) => _AddServiceItemDialog(
        onAdd: (item) {
          setState(() {
            _serviceDetail = _serviceDetail.copyWith(
              bodyshopItems: [..._serviceDetail.bodyshopItems, item],
            );
          });
        },
        itemType: 'bodyshop',
      ),
    );
  }

  void _removePeriodicItem(String itemId) {
    setState(() {
      _serviceDetail = _serviceDetail.copyWith(
        periodicServiceItems: _serviceDetail.periodicServiceItems
            .where((item) => item.id != itemId)
            .toList(),
      );
    });
  }

  void _removeBodyshopItem(String itemId) {
    setState(() {
      _serviceDetail = _serviceDetail.copyWith(
        bodyshopItems: _serviceDetail.bodyshopItems
            .where((item) => item.id != itemId)
            .toList(),
      );
    });
  }

  void _updatePeriodicItem(ServiceItem updatedItem) {
    setState(() {
      final items = _serviceDetail.periodicServiceItems.map((item) {
        return item.id == updatedItem.id ? updatedItem : item;
      }).toList();
      _serviceDetail = _serviceDetail.copyWith(periodicServiceItems: items);
    });
  }

  void _updateBodyshopItem(ServiceItem updatedItem) {
    setState(() {
      final items = _serviceDetail.bodyshopItems.map((item) {
        return item.id == updatedItem.id ? updatedItem : item;
      }).toList();
      _serviceDetail = _serviceDetail.copyWith(bodyshopItems: items);
    });
  }

  @override
  Widget build(BuildContext context) {
    if (_isLoading) {
      return const Scaffold(
        body: Center(child: CircularProgressIndicator()),
      );
    }

    return ResponsiveLayout(
      currentRoute: '/service-details',
      child: Scaffold(
        backgroundColor: const Color(0xFFF9FAFB),
        appBar: AppBar(
          leading: IconButton(
            icon: const Icon(Icons.arrow_back),
            onPressed: () => context.go('/dashboard'),
          ),
          title: const Text('Service Details'),
          backgroundColor: Colors.white,
          elevation: 0,
          actions: [
            _ActionButton(
              label: 'Generate Estimate',
              color: const Color(0xFF3B82F6),
              onPressed: _generateEstimate,
            ),
            const SizedBox(width: 8),
            _ActionButton(
              label: 'Generate Receipt',
              color: const Color(0xFF10B981),
              onPressed: _generateReceipt,
            ),
            const SizedBox(width: 8),
            _ActionButton(
              label: 'Inventory Maker',
              color: const Color(0xFF8B5CF6),
              onPressed: _openInventoryMaker,
            ),
            const SizedBox(width: 8),
            _ActionButton(
              label: 'Process Payment',
              color: const Color(0xFF1F2937),
              onPressed: _processPayment,
            ),
            const SizedBox(width: 8),
            _ActionButton(
              label: 'Delete Interaction',
              color: const Color(0xFFEF4444),
              onPressed: _deleteInteraction,
            ),
            const SizedBox(width: 16),
          ],
        ),
        body: Row(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            // Left Sidebar
            Container(
              width: 320,
              color: Colors.white,
              child: SingleChildScrollView(
                padding: const EdgeInsets.all(24),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    _CustomerSection(customer: _serviceDetail.customer),
                    const SizedBox(height: 24),
                    _VehicleSection(vehicle: _serviceDetail.vehicle),
                    const SizedBox(height: 24),
                    _CustomerNotesSection(
                      notes: _customerNotes,
                      onNotesChanged: (notes) {
                        setState(() => _customerNotes = notes);
                      },
                    ),
                  ],
                ),
              ),
            ),
            
            // Main Content
            Expanded(
              child: SingleChildScrollView(
                padding: const EdgeInsets.all(24),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    const Text(
                      'Service Details',
                      style: TextStyle(
                        fontSize: 20,
                        fontWeight: FontWeight.bold,
                        color: Color(0xFF111827),
                      ),
                    ),
                    const SizedBox(height: 24),
                    
                    // Periodic Service Section
                    _ServiceSection(
                      title: 'Periodic Service',
                      items: _serviceDetail.periodicServiceItems,
                      partsCost: _serviceDetail.periodicPartsCost,
                      labourCost: _serviceDetail.periodicLabourCost,
                      total: _serviceDetail.periodicTotal,
                      onAddPart: _addPeriodicItem,
                      onAddLabor: _addPeriodicItem,
                      onAddOther: _addPeriodicItem,
                      onRemoveItem: _removePeriodicItem,
                      onUpdateItem: _updatePeriodicItem,
                    ),
                    
                    const SizedBox(height: 24),
                    
                    // Bodyshop Section
                    _ServiceSection(
                      title: 'Bodyshop',
                      items: _serviceDetail.bodyshopItems,
                      partsCost: _serviceDetail.bodyshopPartsCost,
                      labourCost: _serviceDetail.bodyshopLabourCost,
                      total: _serviceDetail.bodyshopTotal,
                      onAddPart: _addBodyshopItem,
                      onAddLabor: _addBodyshopItem,
                      onAddOther: _addBodyshopItem,
                      onRemoveItem: _removeBodyshopItem,
                      onUpdateItem: _updateBodyshopItem,
                    ),
                  ],
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }
}

class _ActionButton extends StatelessWidget {
  final String label;
  final Color color;
  final VoidCallback onPressed;

  const _ActionButton({
    required this.label,
    required this.color,
    required this.onPressed,
  });

  @override
  Widget build(BuildContext context) {
    return ElevatedButton(
      onPressed: onPressed,
      style: ElevatedButton.styleFrom(
        backgroundColor: color,
        foregroundColor: Colors.white,
        padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
        shape: RoundedRectangleBorder(
          borderRadius: BorderRadius.circular(6),
        ),
      ),
      child: Text(
        label,
        style: const TextStyle(fontSize: 13, fontWeight: FontWeight.w600),
      ),
    );
  }
}

class _CustomerSection extends StatelessWidget {
  final CustomerInfo customer;

  const _CustomerSection({required this.customer});

  @override
  Widget build(BuildContext context) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Row(
          mainAxisAlignment: MainAxisAlignment.spaceBetween,
          children: [
            const Text(
              'Customer',
              style: TextStyle(
                fontSize: 16,
                fontWeight: FontWeight.bold,
                color: Color(0xFF111827),
              ),
            ),
            Row(
              children: [
                IconButton(
                  icon: const Icon(Icons.edit, size: 18),
                  onPressed: () {
                    // Get the parent state to call _editCustomer
                    final state = context.findAncestorStateOfType<_ServiceDetailsPageState>();
                    state?._editCustomer();
                  },
                  padding: EdgeInsets.zero,
                  constraints: const BoxConstraints(),
                  color: const Color(0xFF6B7280),
                ),
                const SizedBox(width: 8),
                IconButton(
                  icon: const Icon(Icons.person_add, size: 18),
                  onPressed: () {
                    // TODO: Implement profile
                  },
                  padding: EdgeInsets.zero,
                  constraints: const BoxConstraints(),
                  color: const Color(0xFF3B82F6),
                ),
              ],
            ),
          ],
        ),
        const SizedBox(height: 16),
        _InfoRow(label: 'Name', value: customer.name),
        _InfoRow(label: 'Phone', value: customer.phone),
        _InfoRow(label: 'Email', value: customer.email),
        _InfoRow(
          label: 'Date',
          value: '${customer.date.day}/${customer.date.month}/${customer.date.year}',
        ),
        const SizedBox(height: 12),
        TextField(
          decoration: InputDecoration(
            labelText: 'GST Number (Optional)',
            hintText: 'Enter 15-digit GSTIN',
            border: OutlineInputBorder(
              borderRadius: BorderRadius.circular(6),
              borderSide: const BorderSide(color: Color(0xFFE5E7EB)),
            ),
            enabledBorder: OutlineInputBorder(
              borderRadius: BorderRadius.circular(6),
              borderSide: const BorderSide(color: Color(0xFFE5E7EB)),
            ),
            contentPadding: const EdgeInsets.symmetric(horizontal: 12, vertical: 10),
          ),
          style: const TextStyle(fontSize: 13),
        ),
      ],
    );
  }
}

class _VehicleSection extends StatelessWidget {
  final VehicleInfo vehicle;

  const _VehicleSection({required this.vehicle});

  @override
  Widget build(BuildContext context) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Row(
          mainAxisAlignment: MainAxisAlignment.spaceBetween,
          children: [
            const Text(
              'Vehicle',
              style: TextStyle(
                fontSize: 16,
                fontWeight: FontWeight.bold,
                color: Color(0xFF111827),
              ),
            ),
            IconButton(
              icon: const Icon(Icons.edit, size: 18),
              onPressed: () {
                // Get the parent state to call _editVehicle
                final state = context.findAncestorStateOfType<_ServiceDetailsPageState>();
                state?._editVehicle();
              },
              padding: EdgeInsets.zero,
              constraints: const BoxConstraints(),
              color: const Color(0xFF6B7280),
            ),
          ],
        ),
        const SizedBox(height: 16),
        _InfoRow(label: 'Reg. No.', value: vehicle.registrationNumber),
        _InfoRow(label: 'Make & Model', value: vehicle.makeAndModel),
        _InfoRow(label: 'Year', value: vehicle.year.toString()),
        _InfoRow(label: 'Fuel Type', value: vehicle.fuelType),
      ],
    );
  }
}

class _CustomerNotesSection extends StatelessWidget {
  final String notes;
  final ValueChanged<String> onNotesChanged;

  const _CustomerNotesSection({
    required this.notes,
    required this.onNotesChanged,
  });

  @override
  Widget build(BuildContext context) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        const Text(
          'Customer Notes',
          style: TextStyle(
            fontSize: 16,
            fontWeight: FontWeight.bold,
            color: Color(0xFF111827),
          ),
        ),
        const SizedBox(height: 12),
        TextField(
          decoration: InputDecoration(
            hintText: 'Add a new task...',
            border: OutlineInputBorder(
              borderRadius: BorderRadius.circular(6),
              borderSide: const BorderSide(color: Color(0xFFE5E7EB)),
            ),
            enabledBorder: OutlineInputBorder(
              borderRadius: BorderRadius.circular(6),
              borderSide: const BorderSide(color: Color(0xFFE5E7EB)),
            ),
            contentPadding: const EdgeInsets.symmetric(horizontal: 12, vertical: 10),
          ),
          style: const TextStyle(fontSize: 13),
          maxLines: 3,
          onChanged: onNotesChanged,
        ),
        const SizedBox(height: 8),
        Align(
          alignment: Alignment.centerRight,
          child: TextButton(
            onPressed: () {
              // TODO: Add note
            },
            child: const Text('Add'),
          ),
        ),
      ],
    );
  }
}

class _InfoRow extends StatelessWidget {
  final String label;
  final String value;

  const _InfoRow({
    required this.label,
    required this.value,
  });

  @override
  Widget build(BuildContext context) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 12),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(
            label,
            style: const TextStyle(
              fontSize: 12,
              color: Color(0xFF6B7280),
            ),
          ),
          const SizedBox(height: 4),
          Text(
            value,
            style: const TextStyle(
              fontSize: 14,
              color: Color(0xFF111827),
              fontWeight: FontWeight.w500,
            ),
          ),
        ],
      ),
    );
  }
}

class _ServiceSection extends StatelessWidget {
  final String title;
  final List<ServiceItem> items;
  final double partsCost;
  final double labourCost;
  final double total;
  final VoidCallback onAddPart;
  final VoidCallback onAddLabor;
  final VoidCallback onAddOther;
  final Function(String) onRemoveItem;
  final Function(ServiceItem) onUpdateItem;

  const _ServiceSection({
    required this.title,
    required this.items,
    required this.partsCost,
    required this.labourCost,
    required this.total,
    required this.onAddPart,
    required this.onAddLabor,
    required this.onAddOther,
    required this.onRemoveItem,
    required this.onUpdateItem,
  });

  @override
  Widget build(BuildContext context) {
    return Container(
      decoration: BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.circular(8),
        border: Border.all(color: const Color(0xFFE5E7EB)),
      ),
      padding: const EdgeInsets.all(20),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              Row(
                children: [
                  Text(
                    title,
                    style: const TextStyle(
                      fontSize: 16,
                      fontWeight: FontWeight.bold,
                      color: Color(0xFF111827),
                    ),
                  ),
                  const SizedBox(width: 8),
                  const Icon(Icons.edit, size: 16, color: Color(0xFF6B7280)),
                ],
              ),
              Row(
                children: [
                  _SmallButton(label: 'Add Part', onPressed: onAddPart),
                  const SizedBox(width: 8),
                  _SmallButton(label: 'Add Labor', onPressed: onAddLabor),
                  const SizedBox(width: 8),
                  _SmallButton(label: 'Add Other', onPressed: onAddOther),
                ],
              ),
            ],
          ),
          const SizedBox(height: 16),
          
          // Service Items
          ...items.map((item) => _ServiceItemRow(
            item: item,
            onRemove: () => onRemoveItem(item.id),
            onUpdate: onUpdateItem,
          )),
          
          if (items.isEmpty)
            const Padding(
              padding: EdgeInsets.symmetric(vertical: 20),
              child: Center(
                child: Text(
                  'No items added',
                  style: TextStyle(color: Color(0xFF9CA3AF)),
                ),
              ),
            ),
          
          const Divider(height: 32),
          
          // Totals
          Row(
            mainAxisAlignment: MainAxisAlignment.end,
            children: [
              Text(
                'Parts: ₹${partsCost.toStringAsFixed(2)}',
                style: const TextStyle(fontSize: 14, color: Color(0xFF6B7280)),
              ),
              const SizedBox(width: 32),
              Text(
                'Labour: ₹${labourCost.toStringAsFixed(2)}',
                style: const TextStyle(fontSize: 14, color: Color(0xFF6B7280)),
              ),
              const SizedBox(width: 32),
              Text(
                'Total: ₹${total.toStringAsFixed(2)}',
                style: const TextStyle(
                  fontSize: 14,
                  fontWeight: FontWeight.bold,
                  color: Color(0xFF111827),
                ),
              ),
            ],
          ),
        ],
      ),
    );
  }
}

class _SmallButton extends StatelessWidget {
  final String label;
  final VoidCallback onPressed;

  const _SmallButton({
    required this.label,
    required this.onPressed,
  });

  @override
  Widget build(BuildContext context) {
    return OutlinedButton(
      onPressed: onPressed,
      style: OutlinedButton.styleFrom(
        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),
        side: const BorderSide(color: Color(0xFFE5E7EB)),
        shape: RoundedRectangleBorder(
          borderRadius: BorderRadius.circular(4),
        ),
      ),
      child: Text(
        label,
        style: const TextStyle(fontSize: 12, color: Color(0xFF374151)),
      ),
    );
  }
}

class _ServiceItemRow extends StatefulWidget {
  final ServiceItem item;
  final VoidCallback onRemove;
  final Function(ServiceItem) onUpdate;

  const _ServiceItemRow({
    required this.item,
    required this.onRemove,
    required this.onUpdate,
  });

  @override
  State<_ServiceItemRow> createState() => _ServiceItemRowState();
}

class _ServiceItemRowState extends State<_ServiceItemRow> {
  late TextEditingController _quantityController;
  late TextEditingController _costController;

  @override
  void initState() {
    super.initState();
    _quantityController = TextEditingController(
      text: widget.item.quantity.toString(),
    );
    _costController = TextEditingController(
      text: (widget.item.partsCost + widget.item.labourCost).toStringAsFixed(0),
    );
  }

  @override
  void dispose() {
    _quantityController.dispose();
    _costController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 8),
      child: Row(
        children: [
          Expanded(
            flex: 3,
            child: Text(
              widget.item.name,
              style: const TextStyle(fontSize: 14, color: Color(0xFF374151)),
            ),
          ),
          SizedBox(
            width: 80,
            child: TextField(
              controller: _quantityController,
              decoration: const InputDecoration(
                border: InputBorder.none,
                contentPadding: EdgeInsets.symmetric(horizontal: 8),
              ),
              style: const TextStyle(fontSize: 14),
              textAlign: TextAlign.center,
              keyboardType: TextInputType.number,
              onChanged: (value) {
                final qty = int.tryParse(value) ?? widget.item.quantity;
                widget.onUpdate(widget.item.copyWith(quantity: qty));
              },
            ),
          ),
          SizedBox(
            width: 100,
            child: TextField(
              controller: _costController,
              decoration: const InputDecoration(
                border: InputBorder.none,
                contentPadding: EdgeInsets.symmetric(horizontal: 8),
              ),
              style: const TextStyle(fontSize: 14),
              textAlign: TextAlign.center,
              keyboardType: TextInputType.number,
              onChanged: (value) {
                final cost = double.tryParse(value) ?? 0;
                widget.onUpdate(widget.item.copyWith(labourCost: cost));
              },
            ),
          ),
          IconButton(
            icon: const Icon(Icons.close, size: 18),
            onPressed: widget.onRemove,
            padding: EdgeInsets.zero,
            constraints: const BoxConstraints(),
            color: const Color(0xFF6B7280),
          ),
        ],
      ),
    );
  }
}

class _AddServiceItemDialog extends StatefulWidget {
  final Function(ServiceItem) onAdd;
  final String itemType;

  const _AddServiceItemDialog({
    required this.onAdd,
    required this.itemType,
  });

  @override
  State<_AddServiceItemDialog> createState() => _AddServiceItemDialogState();
}

class _AddServiceItemDialogState extends State<_AddServiceItemDialog> {
  final _nameController = TextEditingController();
  final _quantityController = TextEditingController(text: '1');
  final _partsCostController = TextEditingController(text: '0');
  final _labourCostController = TextEditingController(text: '0');

  @override
  void dispose() {
    _nameController.dispose();
    _quantityController.dispose();
    _partsCostController.dispose();
    _labourCostController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return AlertDialog(
      title: const Text('Add Service Item'),
      content: SizedBox(
        width: 400,
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            TextField(
              controller: _nameController,
              decoration: const InputDecoration(
                labelText: 'Item Name',
                border: OutlineInputBorder(),
              ),
            ),
            const SizedBox(height: 16),
            TextField(
              controller: _quantityController,
              decoration: const InputDecoration(
                labelText: 'Quantity',
                border: OutlineInputBorder(),
              ),
              keyboardType: TextInputType.number,
            ),
            const SizedBox(height: 16),
            TextField(
              controller: _partsCostController,
              decoration: const InputDecoration(
                labelText: 'Parts Cost',
                border: OutlineInputBorder(),
              ),
              keyboardType: TextInputType.number,
            ),
            const SizedBox(height: 16),
            TextField(
              controller: _labourCostController,
              decoration: const InputDecoration(
                labelText: 'Labour Cost',
                border: OutlineInputBorder(),
              ),
              keyboardType: TextInputType.number,
            ),
          ],
        ),
      ),
      actions: [
        TextButton(
          onPressed: () => Navigator.pop(context),
          child: const Text('Cancel'),
        ),
        ElevatedButton(
          onPressed: () {
            final item = ServiceItem(
              id: DateTime.now().millisecondsSinceEpoch.toString(),
              name: _nameController.text,
              quantity: int.tryParse(_quantityController.text) ?? 1,
              partsCost: double.tryParse(_partsCostController.text) ?? 0,
              labourCost: double.tryParse(_labourCostController.text) ?? 0,
              itemType: widget.itemType,
            );
            widget.onAdd(item);
            Navigator.pop(context);
          },
          style: ElevatedButton.styleFrom(
            backgroundColor: AppColors.primary,
            foregroundColor: Colors.white,
          ),
          child: const Text('Add'),
        ),
      ],
    );
  }
}
 
 
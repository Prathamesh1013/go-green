<!DOCTYPE html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#000000">
    <meta name="description" content="Car service management application">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Carigar">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icons/icon-152x152.png">
    <title>Carigar</title>
    <!-- Initialize theme before any rendering to prevent flashing -->
    <script>
        // Set initial theme immediately to prevent flash of wrong theme
        if (localStorage.getItem('theme') === 'dark' || 
            (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>
    <link href="../assets/css/styles.css" rel="stylesheet">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/look.css">
    <script src="../assets/js/supabase-db.js"></script>
    <script src="../assets/js/dashboard.js"></script>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful');
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }
    </script>
</head>
<body class="flex min-h-screen flex-col">
    <script>
    </script>
    </div>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col">
        <!-- Top Navbar (Desktop Only) -->
        <div class="top-nav h-16 shadow-md flex items-center px-4 md:px-6 sticky top-0 z-10 relative justify-between md:justify-start hidden md:flex">
            <div class="flex items-center gap-2">
                <span class="text-2xl font-semibold gilroy text-black dark:text-white hidden dark:block">Carigar</span>
            </div>
            <div class="flex gap-6 items-center ml-10">
                <a href="index.html" class="nav-icon-btn active" title="Home">
                    <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7m-9 2v10a1 1 0 001 1h4a1 1 0 001-1V12m-4-2h4" />
                    </svg>
                </a>
                <a href="order.html" class="nav-icon-btn" title="Order">
                    <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                    </svg>
                </a>
                <a href="inventory.html" class="nav-icon-btn" title="Inventory">
                    <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 13H5v6a2 2 0 002 2h10a2 2 0 002-2v-6m-7-2V3m0 0L9 7m3-4l3 4" />
                    </svg>
                </a>
                <a href="carprofile.html" class="nav-icon-btn" title="Car Profile">
                    <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
                    </svg>
                </a>
            </div>
            <div class="ml-auto flex gap-2 items-center">
                <button id="theme-toggle" class="p-2 rounded-lg bg-light-toggle dark:bg-dark-toggle text-light-text dark:text-dark-text hover:bg-light-toggle-hover dark:hover:bg-dark-toggle-hover">
                    <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                    </svg>
                </button>
            </div>
        </div>

        <!-- Main Layout -->
        <div class="main-container flex-1 flex flex-col px-4 md:px-6 pb-6 gap-6">
            <!-- Content Area -->
            <div class="content-area w-full flex flex-col gap-6">
                <!-- Quick Actions Section -->
                <div class="quick-actions p-4 md:p-6 rounded-lg shadow-md border text-light-text dark:text-dark-text">
                    <h2 class="text-xl font-bold mb-4 gilroy">Quick Actions</h2>
                    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
                        <button onclick="window.location.href='new-customer.html'" class="flex flex-col items-center p-4 rounded-lg home-btn hover:bg-blue-300 transition-colors">
                            <svg class="w-6 h-6 mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
                            </svg>
                            <span class="text-sm gilroy font-medium">New Customer</span>
                        </button>
                        <button onclick="window.location.href='order.html'" class="flex flex-col items-center p-4 rounded-lg inventory-btn hover:bg-pink-300 transition-colors">
                            <svg class="w-6 h-6 mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                            </svg>
                            <span class="text-sm gilroy font-medium">New Order</span>
                        </button>
                        <button onclick="window.location.href='followup-reminders.html'" class="flex flex-col items-center p-4 rounded-lg add-job-btn hover:bg-purple-300 transition-colors">
                            <svg class="w-6 h-6 mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <span class="text-sm gilroy font-medium">Follow up & Reminders</span>
                        </button>
                        <button onclick="window.location.href='dealership-directory.html'" class="flex flex-col items-center p-4 rounded-lg add-part-btn hover:bg-teal-300 transition-colors">
                            <svg class="w-6 h-6 mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                            </svg>
                            <span class="text-sm gilroy font-medium">Dealership Directory</span>
                        </button>
                    </div>
                </div>

                <!-- Kanban Board Columns (Horizontal) -->
                <div class="kanban-board p-4 md:p-6 rounded-lg shadow-md border text-light-text dark:text-dark-text overflow-x-auto bg-gray-900">
                    <!-- Upcoming Column -->
                    <div class="kanban-column">
                        <div class="kanban-section p-4 rounded-lg border border-gray-700 bg-gray-800/50 flex-1 flex flex-col">
                            <div class="flex justify-between items-center mb-3">
                                <h4 class="text-md font-semibold gilroy text-white flex items-center">
                                    Upcoming <span id="upcoming-count" class="ml-2 text-xs font-normal text-gray-400">0</span>
                                </h4>
                                <button class="add-vehicle-btn w-8 h-8 flex items-center justify-center bg-purple-500 hover:bg-purple-600 text-white rounded-full text-xl">+</button>
                            </div>
                            <div id="upcoming-vehicles" class="min-h-[60px] flex-1 flex flex-col gap-2 vehicle-drop-zone" data-column="upcoming">
                                <!-- Upcoming vehicles will be loaded here -->
                                <div class="p-3 bg-gray-700 rounded-lg text-center text-gray-300">No upcoming vehicles</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Ongoing Third Party Column -->
                    <div class="kanban-column">
                        <div class="kanban-section p-4 rounded-lg border border-gray-700 bg-gray-800/50 flex-1 flex flex-col">
                            <div class="flex justify-between items-center mb-3">
                                <h4 class="text-md font-semibold gilroy text-white flex items-center">
                                    Ongoing Third Party <span id="third-party-count" class="ml-2 text-xs font-normal text-gray-400">0</span>
                                </h4>
                                <button class="add-vehicle-btn w-8 h-8 flex items-center justify-center bg-purple-500 hover:bg-purple-600 text-white rounded-full text-xl">+</button>
                            </div>
                            <div id="third-party-vehicles" class="min-h-[60px] flex-1 flex flex-col gap-2 vehicle-drop-zone" data-column="third-party">
                                <!-- Third party vehicles will be loaded here -->
                                <div class="p-3 bg-gray-700 rounded-lg text-center text-gray-300">No third-party vehicles</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Ongoing Dealership Column -->
                    <div class="kanban-column">
                        <div class="kanban-section p-4 rounded-lg border border-gray-700 bg-gray-800/50 flex-1 flex flex-col">
                            <div class="flex justify-between items-center mb-3">
                                <h4 class="text-md font-semibold gilroy text-white flex items-center">
                                    Ongoing Dealership <span id="dealership-count" class="ml-2 text-xs font-normal text-gray-400">0</span>
                                </h4>
                                <button class="add-vehicle-btn w-8 h-8 flex items-center justify-center bg-purple-500 hover:bg-purple-600 text-white rounded-full text-xl">+</button>
                            </div>
                            <div id="dealership-vehicles" class="min-h-[60px] flex-1 flex flex-col gap-2 vehicle-drop-zone" data-column="dealership">
                                <!-- Dealership vehicles will be loaded here -->
                                <div class="p-3 bg-gray-700 rounded-lg text-center text-gray-300">No dealership vehicles</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Non Workshop Active Column -->
                    <div class="kanban-column">
                        <div class="kanban-section p-4 rounded-lg border border-gray-700 bg-gray-800/50 flex-1 flex flex-col">
                            <div class="flex justify-between items-center mb-3">
                                <h4 class="text-md font-semibold gilroy text-white flex items-center">
                                    Non Workshop Active <span id="non-workshop-count" class="ml-2 text-xs font-normal text-gray-400">0</span>
                                </h4>
                                <button class="add-vehicle-btn w-8 h-8 flex items-center justify-center bg-purple-500 hover:bg-purple-600 text-white rounded-full text-xl">+</button>
                            </div>
                            <div id="non-workshop-vehicles" class="min-h-[60px] flex-1 flex flex-col gap-2 vehicle-drop-zone" data-column="non-workshop">
                                <!-- Non-workshop vehicles will be loaded here -->
                                <div class="p-3 bg-gray-700 rounded-lg text-center text-gray-300">No non-workshop vehicles</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Payment Pending Column -->
                    <div class="kanban-column">
                        <div class="kanban-section p-4 rounded-lg border border-gray-700 bg-gray-800/50 flex-1 flex flex-col">
                            <div class="flex justify-between items-center mb-3">
                                <h4 class="text-md font-semibold gilroy text-white flex items-center">
                                    Payment Pending <span id="payment-pending-count" class="ml-2 text-xs font-normal text-gray-400">0</span>
                                </h4>
                                <button class="add-vehicle-btn w-8 h-8 flex items-center justify-center bg-purple-500 hover:bg-purple-600 text-white rounded-full text-xl">+</button>
                            </div>
                            <div id="payment-pending-vehicles" class="min-h-[60px] flex-1 flex flex-col gap-2 vehicle-drop-zone" data-column="payment-pending">
                                <!-- Payment pending vehicles will be loaded here -->
                                <div class="p-3 bg-gray-700 rounded-lg text-center text-gray-300">No payment pending vehicles</div>
                            </div>
                        </div>
                    </div>
                    <!-- Completed Column -->
                    <div class="kanban-column">
                        <div class="kanban-section p-4 rounded-lg border border-gray-700 bg-gray-800/50 flex-1 flex flex-col">
                            <div class="flex justify-between items-center mb-3">
                                <h4 class="text-md font-semibold gilroy text-white flex items-center">
                                    Completed <span id="completed-column-count" class="ml-2 text-xs font-normal text-gray-400">0</span>
                                </h4>
                                <button class="add-vehicle-btn w-8 h-8 flex items-center justify-center bg-purple-500 hover:bg-purple-600 text-white rounded-full text-xl">+</button>
                            </div>
                            <div id="completed-vehicles" class="min-h-[60px] flex-1 flex flex-col gap-2 vehicle-drop-zone" data-column="completed">
                                <!-- Completed vehicles will be loaded here -->
                                <div class="p-3 bg-gray-700 rounded-lg text-center text-gray-300">No completed vehicles</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Summary Stats and Other Actions -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Summary Stats -->
                    <div class="summary-stats p-4 md:p-6 rounded-lg shadow-md border text-light-text dark:text-dark-text">
                        <h2 class="text-xl font-bold mb-4 gilroy">Summary</h2>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="stat-card p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                                <div class="text-sm text-muted">Active Orders</div>
                                <div id="active-orders-count" class="text-2xl font-bold text-blue-600 dark:text-blue-400">-</div>
                            </div>
                            <div class="stat-card p-4 bg-green-50 dark:bg-green-900/20 rounded-lg">
                                <div class="text-sm text-muted">Completed This Month</div>
                                <div id="completed-orders-count" class="text-2xl font-bold text-green-600 dark:text-green-400">-</div>
                            </div>
                            <div class="stat-card p-4 bg-purple-50 dark:bg-purple-900/20 rounded-lg">
                                <div class="text-sm text-muted">Total Customers</div>
                                <div id="total-customers-count" class="text-2xl font-bold text-purple-600 dark:text-purple-400">-</div>
                            </div>
                            <div class="stat-card p-4 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg">
                                <div class="text-sm text-muted">Pending Followups</div>
                                <div id="pending-followups-count" class="text-2xl font-bold text-yellow-600 dark:text-yellow-400">-</div>
                            </div>
                        </div>
                    </div>

                    <!-- Reminders and Followups -->
                    <div class="reminders p-4 md:p-6 rounded-lg shadow-md border text-light-text dark:text-dark-text">
                        <h2 class="text-xl font-bold mb-4 gilroy">Reminders & Followups</h2>
                        <div id="reminders-container" class="space-y-3">
                            <!-- Reminders will be loaded here dynamically -->
                            <div class="skeleton-loader p-3 border-l-4 border-yellow-400 bg-yellow-50 dark:bg-yellow-900/20 rounded-r-lg animate-pulse">
                                <div class="h-5 bg-gray-200 dark:bg-gray-700 rounded w-3/4 mb-2"></div>
                                <div class="h-4 bg-gray-200 dark:bg-gray-700 rounded w-1/2 mb-2"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation (Mobile Only) -->
    <div class="bottom-nav fixed bottom-0 left-0 right-0 h-16 bg-white dark:bg-dark-panel shadow-md flex items-center justify-around md:hidden z-20">
        <div class="flex justify-around items-center w-full max-w-md mx-auto py-2">
            <a href="index.html" class="bottom-nav-icon-btn active" title="Home">
                <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7m-9 2v10a1 1 0 001 1h4a1 1 0 001-1V12m-4-2h4" />
                </svg>
            </a>
            <a href="order.html" class="bottom-nav-icon-btn" title="Order">
                <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                </svg>
            </a>
            <a href="inventory.html" class="bottom-nav-icon-btn" title="Inventory">
                <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 13H5v6a2 2 0 002 2h10a2 2 0 002-2v-6m-7-2V3m0 0L9 7m3-4l3 4" />
                </svg>
            </a>
            <a href="carprofile.html" class="bottom-nav-icon-btn" title="Car Profile">
                <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
                </svg>
            </a>
        </div>
    </div>

    <!-- Job Sheet Modal -->
    <div id="job-sheet-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black bg-opacity-50"></div>
        <div class="absolute inset-0 flex items-center justify-center p-4">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col">
                <!-- Modal Header -->
                <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                    <h3 class="text-xl font-semibold text-light-text dark:text-dark-text">New Job Sheet</h3>
                    <button id="close-job-sheet-modal" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <!-- Modal Body -->
                <div class="flex-1 overflow-auto p-6">
                    <!-- Customer Selection Section -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-light-text dark:text-dark-text mb-2">Customer</label>
                        <div class="relative">
                            <input id="customer-search" type="text" placeholder="Search customer by name, phone or email" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-light-panel dark:bg-dark-panel text-light-text dark:text-dark-text">
                            <div id="customer-search-results" class="absolute left-0 right-0 mt-1 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg shadow-lg z-10 max-h-60 overflow-y-auto hidden">
                                <!-- Customer search results will appear here -->
                            </div>
                        </div>
                        <div id="selected-customer" class="mt-3 p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-light-panel dark:bg-dark-panel hidden">
                            <!-- Selected customer details will appear here -->
                        </div>
                    </div>
                    
                    <!-- Vehicle Selection Section -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-light-text dark:text-dark-text mb-2">Vehicle</label>
                        <select id="vehicle-select" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-light-panel dark:bg-dark-panel text-light-text dark:text-dark-text">
                            <option value="">Select a customer first</option>
                        </select>
                    </div>

                    <!-- Tabs for Customer Notes and Order -->
                    <div class="border-b border-gray-200 dark:border-gray-700">
                        <ul class="flex flex-wrap -mb-px">
                            <li class="mr-2">
                                <button id="customer-notes-tab" class="inline-block p-4 border-b-2 border-blue-500 rounded-t-lg active">Customer Notes</button>
                            </li>
                            <li class="mr-2">
                                <button id="order-tab" class="inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300">Order Details</button>
                            </li>
                        </ul>
                    </div>
                    
                    <!-- Tab Content -->
                    <div class="mt-4">
                        <!-- Customer Notes Section -->
                        <div id="customer-notes-content" class="tab-content">
                            <div class="mb-4 flex items-center">
                                <input id="new-note" type="text" placeholder="Add a new note..." class="flex-1 p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-light-panel dark:bg-dark-panel text-light-text dark:text-dark-text">
                                <button id="add-note-btn" class="ml-2 bg-blue-500 hover:bg-blue-600 text-white p-2 rounded-lg">Add</button>
                            </div>
                            <div id="notes-list" class="space-y-2 max-h-80 overflow-y-auto">
                                <!-- Notes will be added here -->
                                <div class="text-gray-500 dark:text-gray-400 text-center p-4">
                                    No notes added yet
                                </div>
                            </div>
                        </div>
                        
                        <!-- Order Section -->
                        <div id="order-content" class="tab-content hidden">
                            <!-- Service Type Selection -->
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-light-text dark:text-dark-text mb-2">Service Type</label>
                                <select id="service-type" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-light-panel dark:bg-dark-panel text-light-text dark:text-dark-text">
                                    <option value="regular">Regular Service</option>
                                    <option value="inspection">Inspection</option>
                                    <option value="repair">Repair</option>
                                    <option value="modification">Modification</option>
                                    <option value="warranty">Warranty Work</option>
                                </select>
                            </div>
                            
                            <!-- Job Templates -->
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-light-text dark:text-dark-text mb-2">Job Template</label>
                                <select id="job-template" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-light-panel dark:bg-dark-panel text-light-text dark:text-dark-text">
                                    <option value="">Select a template</option>
                                    <option value="periodic">Periodic Service</option>
                                    <option value="oil">Oil Change</option>
                                    <option value="brake">Brake Service</option>
                                    <option value="clutch">Clutch Overhaul</option>
                                    <option value="alignment">Wheel Alignment</option>
                                </select>
                            </div>
                            
                            <!-- Jobs List -->
                            <div class="mb-4">
                                <div class="flex justify-between items-center mb-2">
                                    <label class="block text-sm font-medium text-light-text dark:text-dark-text">Jobs</label>
                                    <button id="add-job-btn" class="text-sm bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded">Add Job</button>
                                </div>
                                <div id="jobs-container" class="space-y-3 mb-4">
                                    <!-- Jobs will be added here -->
                                    <div class="text-gray-500 dark:text-gray-400 text-center p-4 border border-dashed border-gray-300 dark:border-gray-600 rounded-lg">
                                        No jobs added yet. Click 'Add Job' to start.
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Pricing Section -->
                            <div class="border-t border-gray-200 dark:border-gray-700 pt-4 mt-4">
                                <div class="flex justify-between mb-2">
                                    <span class="text-light-text dark:text-dark-text">Subtotal:</span>
                                    <span id="subtotal" class="text-light-text dark:text-dark-text">₹0.00</span>
                                </div>
                                <div class="flex justify-between mb-2">
                                    <span class="text-light-text dark:text-dark-text">Tax (18%):</span>
                                    <span id="tax" class="text-light-text dark:text-dark-text">₹0.00</span>
                                </div>
                                <div class="flex justify-between font-bold">
                                    <span class="text-light-text dark:text-dark-text">Total:</span>
                                    <span id="total" class="text-light-text dark:text-dark-text">₹0.00</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Modal Footer -->
                <div class="px-6 py-4 border-t border-gray-200 dark:border-gray-700 flex justify-between">
                    <div>
                        <select id="job-status" class="p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-light-panel dark:bg-dark-panel text-light-text dark:text-dark-text">
                            <option value="scheduled">Schedule for Later</option>
                            <option value="in_progress">Start Right Now</option>
                        </select>
                    </div>
                    <div class="flex space-x-2">
                        <button id="send-estimate-btn" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg">Send Estimate</button>
                        <button id="save-job-btn" class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg">Save Job</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add the Vehicle Details Modal -->
    <div id="vehicle-details-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black bg-opacity-50"></div>
        <div class="absolute inset-0 flex items-center justify-center p-4">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-xl max-h-[90vh] overflow-hidden flex flex-col">
                <!-- Modal Header with Status -->
                <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center space-x-3 flex-1">
                            <span class="font-medium">Status:</span>
                            <select id="vehicle-status-select" class="flex-1 p-2 border border-gray-300 dark:border-gray-600 rounded bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200">
                                <option value="upcoming">Upcoming</option>
                                <option value="third-party">Third Party</option>
                                <option value="dealership">Dealership</option>
                                <option value="non-workshop">Non Workshop</option>
                                <option value="payment-pending">Payment Pending</option>
                                <option value="completed">Completed</option>
                            </select>
                        </div>
                        <button id="close-vehicle-details" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 text-2xl font-bold">
                            &times;
                        </button>
                    </div>
                </div>
                
                <!-- Modal Body -->
                <div class="flex-1 overflow-auto p-4">
                    <!-- Customer Section -->
                    <div class="mb-4">
                        <h3 class="text-lg font-medium mb-2">Customer Name</h3>
                        <div id="vehicle-customer-info" class="p-3 border border-gray-300 dark:border-gray-600 rounded-lg">
                            <div class="font-medium" id="customer-name-display">Loading...</div>
                            <div class="text-sm text-gray-500" id="customer-contact">Loading...</div>
                        </div>
                    </div>
                    
                    <!-- Vehicle Section -->
                    <div class="mb-4">
                        <h3 class="text-lg font-medium mb-2">Vehicle Details</h3>
                        <div id="vehicle-details-info" class="p-3 border border-gray-300 dark:border-gray-600 rounded-lg">
                            <div class="flex justify-between">
                                <span id="vehicle-make-model">Loading...</span>
                                <span id="vehicle-reg-number" class="text-gray-500">Loading...</span>
                            </div>
                            <div class="text-sm mt-1" id="vehicle-extra-details">Loading...</div>
                        </div>
                    </div>
                    
                    <!-- Customer Notes Section -->
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-lg font-medium">Customer Notes</h3>
                            <button id="add-note-button" class="bg-black text-white w-8 h-8 flex items-center justify-center rounded">+</button>
                        </div>
                        <div id="notes-container" class="space-y-2">
                            <!-- Notes will be added here -->
                        </div>
                    </div>
                    
                    <!-- Job Cards Section -->
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-lg font-medium">Job Card</h3>
                            <div class="flex space-x-2">
                                <button id="quick-task-button" class="bg-blue-600 text-white w-8 h-8 flex items-center justify-center rounded" title="Add Quick Task">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                    </svg>
                                </button>
                                <button id="add-job-section-button" class="bg-black text-white w-8 h-8 flex items-center justify-center rounded" title="Add Full Job Sheet">+</button>
                            </div>
                        </div>
                        
                        <!-- Jobs Container - Scrollable -->
                        <div id="jobs-sections-container" class="space-y-3 max-h-[300px] overflow-y-auto">
                            <!-- Default "Other" section -->
                            <div class="job-section p-3 bg-gray-800 rounded-lg">
                                <h4 class="text-white font-medium mb-2">Other</h4>
                                <div class="text-sm text-gray-300 mb-2">Parts: ₹0 Labor: ₹0 Total: ₹0</div>
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="flex space-x-2 mt-3">
                            <button class="add-job-section-btn px-4 py-2 bg-purple-500 text-white rounded">Add Job</button>
                            <button class="add-part-btn px-4 py-2 bg-teal-500 text-white rounded">Add Part</button>
                            <button class="add-labor-btn px-4 py-2 bg-yellow-500 text-white rounded">Add Labor</button>
                        </div>
                        
                        <!-- Totals -->
                        <div class="text-sm mt-3">
                            <span class="font-medium">Parts: ₹<span id="total-parts">0</span></span>
                            <span class="mx-2">Labor: ₹<span id="total-labor">0</span></span>
                            <span class="font-medium">Total: ₹<span id="grand-total">0</span></span>
                        </div>
                    </div>
                    
                    <!-- Export Buttons -->
                    <div class="flex space-x-4 mt-6">
                        <button id="export-estimate-btn" class="px-6 py-3 bg-gray-800 text-white rounded-full border border-gray-600 hover:bg-gray-700">
                            Export Estimate
                        </button>
                        <button id="export-receipt-btn" class="px-6 py-3 bg-gray-800 text-white rounded-full border border-gray-600 hover:bg-gray-700">
                            Export Receipt
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* Update existing styles */
        .main-container {
            padding-bottom: 5rem; /* Add padding for bottom navbar on mobile */
        }

        .nav-btn {
            @apply flex flex-col items-center justify-center gap-1 p-2 rounded-lg transition-colors duration-200;
        }

        .nav-btn.active {
            @apply bg-light-toggle dark:bg-dark-toggle text-light-text dark:text-dark-text;
        }

        .nav-icon {
            @apply w-6 h-6;
        }

        .nav-text {
            @apply text-xs;
        }

        /* Mobile specific styles */
        @media (max-width: 768px) {
            .main-container {
                padding-bottom: 6rem; /* Extra padding for bottom navbar */
            }
            
            .top-nav {
                display: none; /* Hide top navbar on mobile */
            }
            
            .bottom-nav {
                display: flex; /* Show bottom navbar on mobile */
            }
        }

        /* Desktop specific styles */
        @media (min-width: 769px) {
            .top-nav {
                display: flex; /* Show top navbar on desktop */
            }
            
            .bottom-nav {
                display: none; /* Hide bottom navbar on desktop */
            }
        }
    </style>

    <script>
        // UI component initialization moved to dashboard.js
        // Basic theme functionality retained here for immediate page styling
        
        // Set initial theme
        if (localStorage.getItem('theme') === 'dark' || 
            (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        }
        
        // Kanban board functionality moved to dashboard.js
        
        // Define global functions for record status management
        window.getStatus = function(record) {
            return record.service_state || record.status || 'unknown';
        };
        
        window.getLocation = function(record) {
            if (record.location) return record.location;
            
            const status = window.getStatus(record);
            if (status === 'scheduled' || status === 'pending') return 'upcoming';
            if (status === 'completed') return 'completed';
            return 'workshop'; // Default fallback
        };
        
        // Function to update record status when moved between columns
        window.updateRecordStatus = async function(recordId, newStatus) {
            if (window.ServiceDB) {
                try {
                    await window.ServiceDB.updateRecordStatus(recordId, newStatus);
                    console.log(`Record ${recordId} status updated to ${newStatus}`);
                    return true;
                } catch (e) {
                    console.error('Error updating record status:', e);
                    return false;
                }
            }
            return false;
        };
        
    </script>

    <!-- Minimalist Job Sheet Modal -->
    <div id="new-job-sheet-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black bg-opacity-80"></div>
        <div class="absolute inset-0 flex items-center justify-center p-4">
            <div class="bg-[#1a2236] rounded-xl shadow-2xl w-full max-w-sm max-h-[90vh] overflow-y-auto flex flex-col border border-gray-700">
                <!-- Header -->
                <div class="sticky top-0 z-10 bg-[#1a2236] flex items-center justify-between p-4 border-b border-gray-700/50">
                    <h2 class="text-xl font-bold text-white">New Job Sheet</h2>
                    <button id="close-new-job-sheet" class="text-gray-400 hover:text-white transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <!-- Content -->
                <div class="flex-1 flex flex-col p-4 space-y-4">
                    <!-- Customer Section -->
                    <div>
                        <label class="block text-gray-300 text-sm font-medium mb-2">Customer</label>
                        <div class="relative">
                            <input type="text" id="customer-name-input" placeholder="Search customer" 
                                   class="w-full py-3 px-4 pl-9 bg-[#242c40] text-white border border-gray-700 rounded-lg focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500" />
                            <svg class="w-5 h-5 text-gray-400 absolute left-3 top-1/2 transform -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </div>
                    </div>
                    
                    <!-- Customer Selected View (Initially Hidden) -->
                    <div id="selected-customer-view" class="hidden">
                        <div class="p-3 bg-[#242c40] rounded-lg flex items-center">
                            <div class="bg-blue-600 rounded-full p-2 mr-3 flex-shrink-0">
                                <svg class="w-5 h-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                </svg>
                            </div>
                            <div class="flex-1">
                                <div class="text-white font-medium" id="selected-customer-name">John Smith</div>
                                <div class="text-xs text-gray-400" id="selected-customer-phone">555-123-4567</div>
                            </div>
                            <button class="text-gray-400 hover:text-gray-200" id="change-customer-btn">
                                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Customer Search Results (Initially Hidden) -->
                    <div id="customer-search-results" class="hidden bg-[#242c40] rounded-lg shadow-lg overflow-hidden">
                        <div class="max-h-40 overflow-y-auto divide-y divide-gray-700">
                            <div class="customer-result p-3 hover:bg-gray-800 cursor-pointer flex items-center">
                                <div class="bg-blue-600 rounded-full p-1 mr-2 flex-shrink-0">
                                    <svg class="w-4 h-4 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                    </svg>
                                </div>
                                <div>
                                    <div class="text-white text-sm font-medium">John Smith</div>
                                    <div class="text-xs text-gray-400">555-123-4567</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Auto-selected Vehicle or Dropdown (Initially Hidden) -->
                    <div id="vehicle-selection-container" class="hidden">
                        <!-- When only one vehicle -->
                        <div id="single-vehicle-display" class="p-3 bg-[#242c40] rounded-lg">
                            <div class="text-xs text-gray-400 mb-1">Vehicle</div>
                            <div class="text-white" id="selected-vehicle-name">Toyota Corolla (KA-01-AB-1234)</div>
                        </div>
                        
                        <!-- When multiple vehicles -->
                        <div id="multi-vehicle-selection" class="hidden">
                            <label class="block text-gray-300 text-sm font-medium mb-2">Select Vehicle</label>
                            <select class="w-full py-3 px-4 bg-[#242c40] text-white border border-gray-700 rounded-lg focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                                <option>Toyota Corolla (KA-01-AB-1234)</option>
                                <option>Honda City (KA-02-CD-5678)</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Notes Section -->
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <label class="block text-gray-300 text-sm font-medium">Customer Notes</label>
                            <span class="text-xs text-gray-400">0 notes</span>
                        </div>
                        <div id="notes-container">
                            <!-- Notes will appear here -->
                        </div>
                        <div class="flex items-center gap-2 mt-2">
                            <input type="text" placeholder="Add a note..." 
                                  class="flex-1 py-3 px-4 bg-[#242c40] text-white border border-gray-700 rounded-lg focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500" />
                            <button class="bg-blue-600 hover:bg-blue-700 text-white p-2 rounded-lg transition-colors flex-shrink-0">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Order Details -->
                    <div>
                        <label class="block text-gray-300 text-sm font-medium mb-2">Order Details</label>
                        <textarea placeholder="Describe the service needed..." rows="4"
                                class="w-full p-4 bg-[#242c40] text-white border border-gray-700 rounded-lg focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </div>
                </div>
                
                <!-- Footer -->
                <div class="sticky bottom-0 bg-[#1a2236] border-t border-gray-700/50 p-4 flex justify-between">
                    <button id="task-schedule-btn" class="px-4 py-3 bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition-colors">
                        Schedule
                    </button>
                    <button class="px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium">
                        Save Job
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Task Creation Modal -->
    <div id="task-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-gray-800 rounded-lg w-full max-w-md mx-4 overflow-hidden">
            <div class="flex justify-between items-center px-6 py-4 border-b border-gray-700">
                <h3 class="text-lg font-medium text-white">Add Task</h3>
                <button id="close-task-modal" class="text-gray-400 hover:text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div class="p-6">
                <!-- Customer search with autocomplete -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-400 mb-1">Customer</label>
                    <div class="relative">
                        <input type="text" id="customer-search" class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Type to search customer...">
                        <div id="customer-suggestions" class="absolute left-0 right-0 mt-1 bg-gray-700 border border-gray-600 rounded-md max-h-48 overflow-y-auto hidden z-10"></div>
                    </div>
                </div>
                
                <!-- Task name -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-400 mb-1">Task Name</label>
                    <input type="text" id="task-name" class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter task name">
                </div>
                
                <!-- Date and time picker -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-400 mb-1">Schedule</label>
                    <div class="flex space-x-2">
                        <input type="date" id="task-date" class="flex-1 bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <input type="time" id="task-time" class="flex-1 bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                
                <!-- Task type dropdown -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-400 mb-1">Task Type</label>
                    <select id="task-type" class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="inventory">Send Inventory</option>
                        <option value="estimate">Estimate</option>
                        <option value="general">General Task</option>
                    </select>
                </div>
                
                <!-- Action buttons -->
                <div class="flex justify-end">
                    <button id="cancel-task" class="px-4 py-2 text-sm font-medium text-gray-300 hover:text-white">Cancel</button>
                    <button id="add-task" class="ml-3 px-4 py-2 text-sm font-medium bg-blue-600 hover:bg-blue-700 text-white rounded-md">Add Task</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Task Detail Modal -->
    <div id="task-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-gray-800 rounded-lg w-full max-w-2xl mx-4 overflow-hidden">
            <div class="flex justify-between items-center px-6 py-4 border-b border-gray-700">
                <h3 id="task-detail-title" class="text-lg font-medium text-white">Task Details</h3>
                <button id="close-task-detail-modal" class="text-gray-400 hover:text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div class="p-6">
                <!-- Tabs -->
                <div class="border-b border-gray-700">
                    <div class="flex -mb-px">
                        <button class="task-tab active px-4 py-2 text-sm font-medium text-white border-b-2 border-blue-500 mr-4">Customer Notes</button>
                        <button class="task-tab px-4 py-2 text-sm font-medium text-gray-400 hover:text-white mr-4">Order Details</button>
                    </div>
                </div>
                
                <!-- Tab Content -->
                <div class="mt-6">
                    <!-- Customer Notes Tab -->
                    <div id="notes-tab" class="task-tab-content">
                        <div class="flex mb-4">
                            <input type="text" id="new-note" class="flex-1 bg-gray-700 border border-gray-600 rounded-l-md py-2 px-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Add a new note...">
                            <button id="add-note" class="bg-blue-600 hover:bg-blue-700 text-white rounded-r-md px-4">Add</button>
                        </div>
                        
                        <div id="notes-list" class="space-y-2 max-h-64 overflow-y-auto">
                            <div class="text-gray-400 text-center py-4">No notes added yet</div>
                        </div>
                    </div>
                    
                    <!-- Order Details Tab -->
                    <div id="order-tab" class="task-tab-content hidden">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-400 mb-1">Services</label>
                            <div id="services-list" class="space-y-2">
                                <div class="flex justify-between items-center bg-gray-700 p-2 rounded">
                                    <input type="text" class="bg-transparent border-0 text-white flex-1 focus:outline-none" placeholder="Service description">
                                    <input type="text" class="bg-transparent border-0 text-white w-20 text-right focus:outline-none" placeholder="Price">
                                </div>
                                <button id="add-service" class="text-sm text-blue-500 hover:text-blue-400">+ Add service</button>
                            </div>
                        </div>
                        
                        <div class="flex justify-between text-sm text-gray-400 border-t border-gray-700 pt-4 mt-4">
                            <span>Total:</span>
                            <span id="order-total">₹0.00</span>
                        </div>
                        
                        <div class="mt-6 flex justify-end space-x-4">
                            <button id="send-estimate" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded">Send Estimate</button>
                            <button id="create-receipt" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded">Create Receipt</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    // Task Modal Functionality
    document.addEventListener('DOMContentLoaded', function() {
        const addTaskButton = document.querySelector('#add-task-button');
        const taskModal = document.querySelector('#task-modal');
        const closeTaskModal = document.querySelector('#close-task-modal');
        const cancelTask = document.querySelector('#cancel-task');
        const addTaskBtn = document.querySelector('#add-task');
        
        const taskDetailModal = document.querySelector('#task-detail-modal');
        const closeTaskDetailModal = document.querySelector('#close-task-detail-modal');
        
        const customerSearch = document.querySelector('#customer-search');
        const customerSuggestions = document.querySelector('#customer-suggestions');
        
        // Show task modal when add task button is clicked
        if (addTaskButton) {
            addTaskButton.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                taskModal.classList.remove('hidden');
            });
        }
        
        // Customer autocomplete functionality
        customerSearch.addEventListener('input', async function() {
            const searchTerm = this.value.trim();
            
            if (searchTerm.length < 2) {
                customerSuggestions.classList.add('hidden');
                return;
            }
            
            try {
                const { data: customers, error } = await supabaseClient
                    .from('customers')
                    .select('id, name, phone')
                    .or(`name.ilike.%${searchTerm}%,phone.ilike.%${searchTerm}%`)
                    .limit(10);
                    
                if (error) {
                    console.error('Error fetching customers:', error);
                    return;
                }
                
                if (customers && customers.length > 0) {
                    customerSuggestions.innerHTML = '';
                    
                    customers.forEach(customer => {
                        const item = document.createElement('div');
                        item.className = 'p-2 hover:bg-gray-600 cursor-pointer';
                        item.textContent = `${customer.name} - ${customer.phone}`;
                        item.dataset.id = customer.id;
                        item.dataset.name = customer.name;
                        
                        item.addEventListener('click', function() {
                            customerSearch.value = customer.name;
                            customerSearch.dataset.id = customer.id;
                            customerSuggestions.classList.add('hidden');
                        });
                        
                        customerSuggestions.appendChild(item);
                    });
                    
                    customerSuggestions.classList.remove('hidden');
                } else {
                    customerSuggestions.classList.add('hidden');
                }
            } catch (err) {
                console.error('Error in customer search:', err);
            }
        });
        
        // Hide suggestions when clicking outside
        document.addEventListener('click', function(e) {
            if (!customerSearch.contains(e.target)) {
                customerSuggestions.classList.add('hidden');
            }
        });
        
        // Add task
        if (addTaskBtn) {
            addTaskBtn.addEventListener('click', function() {
                const customerId = customerSearch.dataset.id || null;
                const customerName = customerSearch.value.trim();
                const taskName = document.querySelector('#task-name').value.trim() || customerName;
                const taskDate = document.querySelector('#task-date').value;
                const taskTime = document.querySelector('#task-time').value;
                const taskType = document.querySelector('#task-type').value;
                
                if (!taskName) {
                    alert('Please enter a task name or select a customer');
                    return;
                }
                
                // Create a new task card
                const taskCard = document.createElement('div');
                taskCard.className = 'task-card p-3 bg-gray-700 rounded-lg shadow-md border border-gray-600 hover:border-gray-400';
                taskCard.dataset.customerId = customerId;
                taskCard.dataset.taskType = taskType;
                
                // Format date and time for display
                let scheduleText = '';
                if (taskDate) {
                    const date = new Date(taskDate);
                    scheduleText = date.toLocaleDateString();
                    if (taskTime) {
                        scheduleText += ' ' + taskTime;
                    }
                }
                
                taskCard.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-medium text-white">${taskName}</h4>
                            <p class="text-xs text-gray-400">${scheduleText || 'No schedule set'}</p>
                        </div>
                        <span class="text-xs px-2 py-1 rounded bg-blue-900 text-blue-300">${taskType}</span>
                    </div>
                `;
                
                // Add the task to the appropriate section
                const jobSectionsContainer = document.querySelector('#jobs-sections-container');
                if (jobSectionsContainer) {
                    // Add to first section for now - this could be improved to add to relevant section
                    const firstSection = jobSectionsContainer.querySelector('.job-section');
                    if (firstSection) {
                        if (firstSection.querySelector('.text-sm.text-gray-300')) {
                            // Remove the "no tasks" message if it exists
                            firstSection.querySelector('.text-sm.text-gray-300').remove();
                        }
                        firstSection.appendChild(taskCard);
                    }
                }
                
                // Clear the modal form
                customerSearch.value = '';
                customerSearch.dataset.id = '';
                document.querySelector('#task-name').value = '';
                document.querySelector('#task-date').value = '';
                document.querySelector('#task-time').value = '';
                
                // Hide the modal
                taskModal.classList.add('hidden');
                
                // Add click listener to open task details
                taskCard.addEventListener('click', function() {
                    document.querySelector('#task-detail-title').textContent = taskName;
                    taskDetailModal.classList.remove('hidden');
                    
                    // Reset tab state
                    document.querySelectorAll('.task-tab').forEach(tab => tab.classList.remove('active'));
                    document.querySelectorAll('.task-tab-content').forEach(content => content.classList.add('hidden'));
                    document.querySelector('.task-tab').classList.add('active');
                    document.querySelector('#notes-tab').classList.remove('hidden');
                });
            });
        }
        
        // Close task detail modal
        if (closeTaskDetailModal) {
            closeTaskDetailModal.addEventListener('click', function() {
                taskDetailModal.classList.add('hidden');
            });
        }
        
        // Tab switching in task detail modal
        document.querySelectorAll('.task-tab').forEach((tab, index) => {
            tab.addEventListener('click', function() {
                // Remove active state from all tabs
                document.querySelectorAll('.task-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.task-tab-content').forEach(c => c.classList.add('hidden'));
                
                // Add active state to clicked tab
                this.classList.add('active');
                const tabs = document.querySelectorAll('.task-tab-content');
                if (tabs[index]) {
                    tabs[index].classList.remove('hidden');
                }
            });
        });
        
        // Add note functionality
        const addNoteBtn = document.querySelector('#add-note');
        const newNoteInput = document.querySelector('#new-note');
        const notesList = document.querySelector('#notes-list');
        
        if (addNoteBtn && newNoteInput && notesList) {
            addNoteBtn.addEventListener('click', function() {
                const noteText = newNoteInput.value.trim();
                
                if (noteText) {
                    // Clear the "no notes" message if it exists
                    if (notesList.querySelector('.text-gray-400')) {
                        notesList.innerHTML = '';
                    }
                    
                    const noteItem = document.createElement('div');
                    noteItem.className = 'bg-gray-700 p-3 rounded border border-gray-600';
                    noteItem.textContent = noteText;
                    
                    notesList.appendChild(noteItem);
                    newNoteInput.value = '';
                }
            });
        }
        
        // Add service functionality
        const addServiceBtn = document.querySelector('#add-service');
        const servicesList = document.querySelector('#services-list');
        
        if (addServiceBtn && servicesList) {
            addServiceBtn.addEventListener('click', function() {
                const serviceRow = document.createElement('div');
                serviceRow.className = 'flex justify-between items-center bg-gray-700 p-2 rounded';
                serviceRow.innerHTML = `
                    <input type="text" class="bg-transparent border-0 text-white flex-1 focus:outline-none" placeholder="Service description">
                    <input type="text" class="bg-transparent border-0 text-white w-20 text-right focus:outline-none" placeholder="Price">
                    <button class="delete-service ml-2 text-red-500">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                `;
                
                // Insert before the add button
                servicesList.insertBefore(serviceRow, addServiceBtn);
                
                // Add event listener to delete button
                const deleteBtn = serviceRow.querySelector('.delete-service');
                deleteBtn.addEventListener('click', function() {
                    serviceRow.remove();
                    updateOrderTotal();
                });
                
                // Add event listeners to price input for total calculation
                const priceInput = serviceRow.querySelector('input:last-of-type');
                priceInput.addEventListener('input', updateOrderTotal);
            });
        }
        
        function updateOrderTotal() {
            let total = 0;
            const priceInputs = document.querySelectorAll('#services-list input:nth-child(2)');
            
            priceInputs.forEach(input => {
                const price = parseFloat(input.value) || 0;
                total += price;
            });
            
            const orderTotal = document.querySelector('#order-total');
            if (orderTotal) {
                orderTotal.textContent = `₹${total.toFixed(2)}`;
            }
        }
    });
    </script>

    <!-- Quick Task Button Script -->
    <script>
    // Task Modal Initialization Script
    document.addEventListener('DOMContentLoaded', function() {
        const quickTaskBtn = document.getElementById('quick-task-button');
        const taskModal = document.getElementById('task-modal');
        
        if (quickTaskBtn && taskModal) {
            quickTaskBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('Quick task button clicked!');
                taskModal.classList.remove('hidden');
                
                // Hide any other modals
                const otherModals = document.querySelectorAll('#job-sheet-modal, #new-job-sheet-modal, #vehicle-details-modal');
                otherModals.forEach(modal => {
                    if (modal) modal.classList.add('hidden');
                });
            });
        } else {
            console.error('Quick task button or task modal not found!');
        }

        // Set up close buttons
        const closeButtons = document.querySelectorAll('#close-task-modal, #cancel-task');
        closeButtons.forEach(button => {
            if (button) {
                button.addEventListener('click', function() {
                    if (taskModal) taskModal.classList.add('hidden');
                });
            }
        });
    });
    </script>
</body>
</html>

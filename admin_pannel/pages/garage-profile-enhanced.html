<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Garage Profile Manager - Carigar</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="../assets/css/styles.css" rel="stylesheet">
    <link href="../assets/css/dark-mode.css" rel="stylesheet">
    <script src="../assets/js/dark-mode-init.js"></script>
    <style>
        :root {
            --primary-color: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary-color: #64748b;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --background-color: #f8fafc;
            --surface-color: #ffffff;
            --border-color: #e2e8f0;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
        }

        .dark {
            --background-color: #0f172a;
            --surface-color: #1e293b;
            --border-color: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--background-color);
            color: var(--text-primary);
            line-height: 1.6;
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            padding: 40px 0;
            border-radius: 16px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .tabs {
            display: flex;
            background: var(--surface-color);
            border-radius: 12px;
            padding: 4px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 1px solid var(--border-color);
            overflow-x: auto;
        }

        .tab {
            flex: 1;
            min-width: 150px;
            padding: 16px 24px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            border-radius: 8px;
            color: var(--text-secondary);
            white-space: nowrap;
        }

        .tab.active {
            background: var(--primary-color);
            color: white;
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.3);
        }

        .tab:hover:not(.active) {
            background: var(--background-color);
            color: var(--text-primary);
        }

        .content {
            background: var(--surface-color);
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            border: 1px solid var(--border-color);
        }

        .form-section {
            display: none;
        }

        .form-section.active {
            display: block;
        }

        .form-group {
            margin-bottom: 32px;
        }

        .form-group h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 20px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
            margin-bottom: 24px;
        }

        .form-field {
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
            font-size: 0.875rem;
        }

        .required::after {
            content: " *";
            color: var(--danger-color);
        }

        input, select, textarea {
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: var(--surface-color);
            color: var(--text-primary);
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .vendor-type-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .vendor-type-card {
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--surface-color);
        }

        .vendor-type-card:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(37, 99, 235, 0.15);
        }

        .vendor-type-card.selected {
            border-color: var(--primary-color);
            background: rgba(37, 99, 235, 0.05);
            box-shadow: 0 8px 25px rgba(37, 99, 235, 0.15);
        }

        .vendor-type-card i {
            font-size: 2.5rem;
            color: var(--primary-color);
            margin-bottom: 12px;
        }

        .vendor-type-card h4 {
            margin: 0 0 8px 0;
            color: var(--text-primary);
            font-size: 1.1rem;
        }

        .vendor-type-card p {
            margin: 0;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .rating-stars {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .star {
            font-size: 1.2rem;
            color: #d1d5db;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .star.filled {
            color: #fbbf24;
        }

        .star:hover {
            color: #fbbf24;
        }

        .photo-upload {
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            background: var(--background-color);
        }

        .photo-upload:hover {
            border-color: var(--primary-color);
            background: rgba(37, 99, 235, 0.05);
        }

        .photo-upload.dragover {
            border-color: var(--primary-color);
            background: rgba(37, 99, 235, 0.1);
        }

        .photo-upload i {
            font-size: 3rem;
            color: var(--text-secondary);
            margin-bottom: 16px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: 0 8px 25px rgba(37, 99, 235, 0.3);
        }

        .btn-secondary {
            background: var(--secondary-color);
            color: white;
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .profile-actions {
            display: flex;
            gap: 8px;
        }

        .profile-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .detail-item {
            background: var(--background-color);
            padding: 16px;
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
            margin-bottom: 16px;
        }

        .detail-label {
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 4px;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .detail-value {
            color: var(--text-primary);
            font-weight: 500;
        }

        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 8px;
            margin-top: 12px;
        }

        .photo-grid img {
            width: 100%;
            height: 80px;
            object-fit: cover;
            border-radius: 6px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .photo-grid img:hover {
            transform: scale(1.05);
        }

        .photo-preview {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 16px;
            margin-top: 20px;
        }

        .photo-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .photo-item img {
            width: 100%;
            height: 120px;
            object-fit: cover;
        }

        .photo-item.existing-photo {
            border: 2px solid #10b981;
        }

        .photo-item.removed {
            opacity: 0.5;
            filter: grayscale(100%);
        }

        .existing-label {
            position: absolute;
            top: 5px;
            left: 5px;
            background: #10b981;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
        }

        .existing-photo-remove {
            background: #ef4444 !important;
        }

        .existing-photo-remove:hover {
            background: #dc2626 !important;
        }

        .photo-remove {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        /* Existing Photos Grid */
        .existing-photos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .existing-photo-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 2px solid var(--border-color);
        }

        .existing-photo-item img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            cursor: pointer;
        }

        .existing-photo-item:hover {
            border-color: var(--primary-color);
        }

        .existing-photo-remove {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .existing-photo-remove:hover {
            background: rgba(239, 68, 68, 1);
            transform: scale(1.1);
        }

        /* Form field styling */
        .form-field small {
            color: var(--text-secondary);
            font-size: 0.75rem;
            margin-top: 4px;
            display: block;
        }

        .profile-photos {
            margin-top: 20px;
        }

        .profile-photos h4 {
            margin-bottom: 12px;
            color: var(--text-secondary);
        }

        .search-bar {
            margin-bottom: 24px;
        }

        .search-bar input {
            width: 100%;
            max-width: 400px;
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            background: var(--surface-color);
            color: var(--text-primary);
        }

        .search-bar input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .success-message {
            background: #d1fae5;
            color: #065f46;
            padding: 16px 20px;
            border-radius: 8px;
            margin-bottom: 24px;
            border: 1px solid #a7f3d0;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .error-message {
            background: #fee2e2;
            color: #991b1b;
            padding: 16px 20px;
            border-radius: 8px;
            margin-bottom: 24px;
            border: 1px solid #fecaca;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Analytics Styles */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .analytics-card {
            background: var(--surface-color);
            padding: 24px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 1px solid var(--border-color);
        }

        .analytics-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 8px;
        }

        .analytics-card h4 {
            color: var(--text-secondary);
            font-weight: 500;
            margin: 0;
        }

        .vendor-type-breakdown {
            margin-top: 30px;
        }

        .vendor-type-breakdown h4 {
            margin-bottom: 20px;
            color: var(--text-primary);
        }

        .breakdown-chart {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .breakdown-item {
            background: var(--surface-color);
            padding: 16px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .breakdown-label {
            font-weight: 600;
            color: var(--text-primary);
        }

        .breakdown-count {
            background: var(--primary-color);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.875rem;
        }

        .interactions-summary {
            margin-top: 30px;
        }

        .interactions-summary h4 {
            margin-bottom: 20px;
            color: var(--text-primary);
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .summary-item {
            background: var(--surface-color);
            padding: 16px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            text-align: center;
        }

        .summary-label {
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
            font-size: 0.875rem;
        }

        .summary-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        /* Rating Card Styles */
        .rating-card {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .rating-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .rating-header h4 {
            margin: 0;
            color: var(--text-primary);
        }

        .rating-details p {
            margin: 8px 0;
            color: var(--text-primary);
        }

        .rating-details strong {
            color: var(--text-secondary);
        }

        .profile-card {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .profile-card:hover {
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            border-color: var(--primary-color);
        }

        .profile-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .profile-name {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .vendor-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: var(--primary-color);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 12px;
        }

        .rating-display {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
        }

        .rating-stars {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .star {
            font-size: 1.2rem;
            color: #d1d5db;
            transition: color 0.2s ease;
        }

        .star.filled {
            color: #fbbf24;
        }

        .rating-number {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .rating-count {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .content {
                padding: 20px;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .vendor-type-grid {
                grid-template-columns: 1fr;
            }
            
            .profile-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-tools"></i> Enhanced Garage Profile Manager</h1>
            <p>Comprehensive automotive service center and vendor management system</p>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="showTab('add')">
                <i class="fas fa-plus"></i> Add New Profile
            </div>
            <div class="tab" onclick="showTab('view')">
                <i class="fas fa-list"></i> View Profiles
            </div>
            <div class="tab" onclick="showTab('ratings')">
                <i class="fas fa-star"></i> Manage Ratings
            </div>
            <div class="tab" onclick="showTab('analytics')">
                <i class="fas fa-chart-bar"></i> Analytics
            </div>
        </div>

        <div class="content">
            <!-- Add Profile Form -->
            <div id="addSection" class="form-section active">
                <form id="garageForm">
                    <div class="form-group">
                        <h3><i class="fas fa-info-circle"></i> Basic Information</h3>
                        <div class="form-row">
                            <div class="form-field">
                                <label for="garageName" class="required">Business Name</label>
                                <input type="text" id="garageName" name="garageName" required>
                            </div>
                            <div class="form-field">
                                <label for="vendorType" class="required">Vendor Type</label>
                                <select id="vendorType" name="vendorType" required onchange="updateVendorSubtypes()">
                                    <option value="">Select Vendor Type</option>
                                    <option value="mechanical">Mechanical Workshop</option>
                                    <option value="bodyshop">Bodyshop</option>
                                    <option value="car_accessories">Car Accessories Shop</option>
                                    <option value="wash_detailing">Wash & Detailing Studio</option>
                                    <option value="insurance_agent">Insurance Agent</option>
                                    <option value="rto_agent">RTO Agent</option>
                                    <option value="spare_parts">Spare Parts Vendor</option>
                                    <option value="freelancer">Freelancer</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-field">
                                <label for="vendorSubtype">Specialization</label>
                                <select id="vendorSubtype" name="vendorSubtype">
                                    <option value="">Select Specialization</option>
                                </select>
                            </div>
                            <div class="form-field">
                                <label for="contactPerson">Contact Person</label>
                                <input type="text" id="contactPerson" name="contactPerson">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-field">
                                <label for="location">Location/Address</label>
                                <input type="text" id="location" name="location">
                            </div>
                            <div class="form-field">
                                <label for="phone">Phone Number</label>
                                <input type="tel" id="phone" name="phone">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-field">
                                <label for="email">Email</label>
                                <input type="email" id="email" name="email">
                            </div>
                            <div class="form-field">
                                <label for="website">Website</label>
                                <input type="url" id="website" name="website" placeholder="https://...">
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <h3><i class="fas fa-clock"></i> Business Hours & Operations</h3>
                        <div class="form-row">
                            <div class="form-field">
                                <label for="operatingHours">Operating Hours</label>
                                <input type="text" id="operatingHours" name="operatingHours" placeholder="e.g., 9 AM - 7 PM">
                            </div>
                            <div class="form-field">
                                <label for="emergencyService">Emergency Service Available</label>
                                <select id="emergencyService" name="emergencyService">
                                    <option value="false">No</option>
                                    <option value="true">Yes</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-field">
                                <label for="homeService">Home Service Available</label>
                                <select id="homeService" name="homeService">
                                    <option value="false">No</option>
                                    <option value="true">Yes</option>
                                </select>
                            </div>
                            <div class="form-field">
                                <label for="towingService">Towing Service</label>
                                <select id="towingService" name="towingService">
                                    <option value="false">No</option>
                                    <option value="true">Yes</option>
                                </select>
                            </div>
                        </div>
                    </div>

                                                <div class="form-group">
                                <h3><i class="fas fa-cogs"></i> Services & Specializations</h3>
                                <div class="form-row">
                                    <div class="form-field">
                                        <label for="specializations">Specializations</label>
                                        <textarea id="specializations" name="specializations" rows="3" placeholder="List your key specializations or areas of expertise"></textarea>
                                    </div>
                                    <div class="form-field">
                                        <label for="certifications">Certifications</label>
                                        <textarea id="certifications" name="certifications" rows="3" placeholder="List any professional certifications or training"></textarea>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-field">
                                        <label for="warrantyOffered">Warranty Offered</label>
                                        <select id="warrantyOffered" name="warrantyOffered" onchange="toggleWarrantyPeriod()">
                                            <option value="false">No</option>
                                            <option value="true">Yes</option>
                                        </select>
                                    </div>
                                    <div class="form-field">
                                        <label for="warrantyPeriod">Warranty Period</label>
                                        <input type="text" id="warrantyPeriod" name="warrantyPeriod" placeholder="e.g., 6 months, 1 year" disabled>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <h3><i class="fas fa-eye"></i> Profile Visibility & Settings</h3>
                                <div class="form-row">
                                    <div class="form-field">
                                        <label for="profileVisible">Show Profile to Customers</label>
                                        <select id="profileVisible" name="profileVisible">
                                            <option value="true">Yes - Public Profile</option>
                                            <option value="false">No - Private Profile</option>
                                        </select>
                                        <small>When enabled, customers can see this profile in search results</small>
                                    </div>
                                    <div class="form-field">
                                        <label for="featuredProfile">Featured Profile</label>
                                        <select id="featuredProfile" name="featuredProfile">
                                            <option value="false">Regular Profile</option>
                                            <option value="true">Featured (Top of Results)</option>
                                        </select>
                                        <small>Featured profiles appear first in search results</small>
                                    </div>
                                </div>
                            </div>

                                                <div class="form-group">
                                <h3><i class="fas fa-camera"></i> Photos & Media</h3>
                                
                                <!-- Existing Photos Section -->
                                <div id="existingPhotosSection" style="display: none;">
                                    <h4><i class="fas fa-images"></i> Current Photos</h4>
                                    <div id="existingPhotosGrid" class="existing-photos-grid"></div>
                                </div>
                                
                                <!-- Upload Section -->
                                <div class="photo-upload" id="photoUpload" onclick="document.getElementById('photoInput').click()">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                    <p>Click to upload new photos or drag and drop</p>
                                    <p style="font-size: 0.875rem; color: var(--text-secondary);">Supports JPG, PNG, GIF (Max 5MB each)</p>
                                </div>
                                <input type="file" id="photoInput" multiple accept="image/*" style="display: none;">
                                
                                <!-- New Photos Preview -->
                                <div id="newPhotosSection" style="display: none;">
                                    <h4><i class="fas fa-plus"></i> New Photos to Upload</h4>
                                    <div class="photo-preview" id="photoPreview"></div>
                                </div>
                            </div>

                    <div class="form-group">
                        <div class="btn-group">
                            <button type="submit" class="btn btn-primary" id="submitBtn">
                                <i class="fas fa-save"></i> Save Profile
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="resetForm()">
                                <i class="fas fa-undo"></i> Reset Form
                            </button>
                        </div>
                    </div>
                </form>
            </div>

            <!-- View Profiles -->
            <div id="viewSection" class="form-section">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                            <h3><i class="fas fa-list"></i> Garage & Vendor Profiles</h3>
                            <div class="btn-group">
                                <button class="btn btn-success" onclick="exportData()">
                                    <i class="fas fa-download"></i> Export
                                </button>
                                <button class="btn btn-secondary" onclick="refreshProfiles()">
                                    <i class="fas fa-sync"></i> Refresh
                                </button>
                                <button class="btn btn-primary" onclick="testConnection()">
                                    <i class="fas fa-database"></i> Test Connection
                                </button>
                                <button class="btn btn-secondary" onclick="debugSupabaseState()">
                                    <i class="fas fa-bug"></i> Debug
                                </button>
                            </div>
                        </div>

                <div class="search-bar">
                    <input type="text" id="searchInput" placeholder="Search profiles..." onkeyup="filterProfiles()">
                </div>

                <div id="profilesList">
                    <div class="empty-state">
                        <i class="fas fa-tools"></i>
                        <h3>No profiles found</h3>
                        <p>Start by adding your first garage or vendor profile</p>
                    </div>
                </div>
            </div>

            <!-- Ratings Management -->
            <div id="ratingsSection" class="form-section">
                <h3><i class="fas fa-star"></i> Ratings & Reviews Management</h3>
                <p>Manage ratings and reviews for all garage and vendor interactions.</p>
                <div id="ratingsList">
                    <!-- Ratings will be loaded here -->
                </div>
            </div>

            <!-- Analytics -->
            <div id="analyticsSection" class="form-section">
                <h3><i class="fas fa-chart-bar"></i> Analytics & Insights</h3>
                <p>View performance metrics and insights for your garage and vendor network.</p>
                <div id="analyticsContent">
                    <!-- Analytics will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <script src="../assets/js/supabase.js"></script>
    <script>
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, starting initialization...');
            
            // Simple initialization without complex waiting
            initializeApp();
        });

        // Initialize the application
        async function initializeApp() {
            try {
                console.log('Initializing application...');
                
                // Wait for Supabase library to be available
                await waitForSupabase();
                
                console.log('Supabase ready, initializing components...');
                
                // Initialize components
                initializePhotoUpload();
                loadProfiles();
                setupFormSubmission();
                
                console.log('Application initialized successfully');
                
            } catch (error) {
                console.error('Failed to initialize application:', error);
                
                // Show error state
                showError('Failed to connect to database. Please refresh the page.');
                
                // Show manual initialization option
                const profilesList = document.getElementById('profilesList');
                if (profilesList) {
                    profilesList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-exclamation-triangle"></i>
                            <h3>Connection Failed</h3>
                            <p>Unable to connect to the database. This could be due to:</p>
                            <ul style="text-align: left; margin: 20px 0;">
                                <li>Network connectivity issues</li>
                                <li>Supabase service temporarily unavailable</li>
                                <li>Browser compatibility issues</li>
                            </ul>
                            <div class="btn-group">
                                <button class="btn btn-primary" onclick="retryInitialization()">
                                    <i class="fas fa-sync"></i> Retry Connection
                                </button>
                                <button class="btn btn-secondary" onclick="location.reload()">
                                    <i class="fas fa-redo"></i> Refresh Page
                                </button>
                            </div>
                        </div>
                    `;
                }
                
                // Add fallback initialization
                setTimeout(() => {
                    console.log('Attempting fallback initialization...');
                    if (window.supabase && typeof window.supabase.createClient === 'function') {
                        try {
                            window.supabaseClient = window.supabase.createClient(
                                'https://mtclazwwcsjwuqydxtzj.supabase.co',
                                'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im10Y2xhend3Y3Nqd3VxeWR4dHpqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk3NTIzNzUsImV4cCI6MjA2NTMyODM3NX0.q-I1f6rr9E7XiloHLWZ3mBC963Sk5Zjt3lKneFLTqHA'
                            );
                            console.log('Fallback Supabase client initialized');
                            initializePhotoUpload();
                            loadProfiles();
                            setupFormSubmission();
                        } catch (fallbackError) {
                            console.error('Fallback initialization also failed:', fallbackError);
                        }
                    }
                }, 2000);
            }
        }

        // Wait for Supabase client to be available
        async function waitForSupabase() {
            let attempts = 0;
            const maxAttempts = 50; // 5 seconds max wait
            
            while (attempts < maxAttempts) {
                // Check if client already exists
                if (window.supabaseClient) {
                    console.log('Supabase client already exists');
                    return true;
                }
                
                // Check if Supabase library is available
                if (window.supabase && typeof window.supabase.createClient === 'function') {
                    try {
                        // Initialize the global supabase client with error handling
                        window.supabaseClient = window.supabase.createClient(
                            'https://mtclazwwcsjwuqydxtzj.supabase.co',
                            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im10Y2xhend3Y3Nqd3VxeWR4dHpqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk3NTIzNzUsImV4cCI6MjA2NTMyODM3NX0.q-I1f6rr9E7XiloHLWZ3mBC963Sk5Zjt3lKneFLTqHA',
                            {
                                auth: {
                                    autoRefreshToken: false,
                                    persistSession: false,
                                    detectSessionInUrl: false
                                },
                                realtime: {
                                    params: {
                                        eventsPerSecond: 10
                                    }
                                }
                            }
                        );
                        console.log('Supabase client initialized successfully');
                        return true;
                    } catch (error) {
                        console.error('Error creating Supabase client:', error);
                        throw error;
                    }
                }
                
                // Check if external supabase.js already created a client
                if (window.supabase && typeof window.supabase.from === 'function') {
                    console.log('External Supabase client detected, using it');
                    window.supabaseClient = window.supabase;
                    return true;
                }
                
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }
            
            throw new Error('Supabase client not available after maximum attempts');
        }

        // Setup form submission
        function setupFormSubmission() {
            const form = document.getElementById('garageForm');
            if (form) {
                form.addEventListener('submit', handleFormSubmission);
                
                // Also prevent form submission when editing
                form.addEventListener('submit', (e) => {
                    if (window.currentProfile && window.currentProfile.id) {
                        e.preventDefault();
                        console.log('Form submission prevented - editing mode, calling updateProfile');
                        updateProfile();
                    }
                });
            }
        }

        // Test database connection
        async function testConnection() {
            try {
                if (!window.supabaseClient) {
                    showError('Supabase client not initialized');
                    return;
                }
                
                showSuccessMessage('Testing connection...');
                
                // Simple test query
                const { data, error } = await window.supabaseClient
                    .from('garage_profiles')
                    .select('count')
                    .limit(1);
                
                if (error) throw error;
                
                showSuccessMessage('Database connection successful!');
                
            } catch (error) {
                console.error('Connection test failed:', error);
                showError(`Connection test failed: ${error.message}`);
            }
        }

        // Debug Supabase state
        function debugSupabaseState() {
            console.log('=== Supabase Debug Info ===');
            console.log('window.supabase:', window.supabase);
            console.log('window.supabaseClient:', window.supabaseClient);
            console.log('typeof window.supabase:', typeof window.supabase);
            console.log('typeof window.supabase.createClient:', typeof window.supabase?.createClient);
            console.log('typeof window.supabase.from:', typeof window.supabase?.from);
            console.log('========================');
            
            // Show in UI
            const debugInfo = `
                Supabase Library: ${typeof window.supabase}
                CreateClient Function: ${typeof window.supabase?.createClient}
                From Function: ${typeof window.supabase?.from}
                Client Instance: ${window.supabaseClient ? 'Yes' : 'No'}
            `;
            
            showSuccessMessage('Debug info logged to console');
            console.log(debugInfo);
        }

        // Retry initialization manually
        async function retryInitialization() {
            try {
                showSuccessMessage('Retrying connection...');
                
                // Clear any existing client
                window.supabaseClient = null;
                
                // Wait for Supabase to be available
                await waitForSupabase();
                
                // Initialize components
                initializePhotoUpload();
                loadProfiles();
                setupFormSubmission();
                
                showSuccessMessage('Connection restored successfully!');
                
            } catch (error) {
                console.error('Retry initialization failed:', error);
                showError('Failed to restore connection. Please refresh the page.');
            }
        }

        function showTab(tabName) {
            // Hide all sections
            document.querySelectorAll('.form-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected section and tab
            const tabIndex = {
                'add': 0,
                'view': 1,
                'ratings': 2,
                'analytics': 3
            };
            
            document.getElementById(tabName + 'Section').classList.add('active');
            document.querySelectorAll('.tab')[tabIndex[tabName]].classList.add('active');
            
            if (tabName === 'view') {
                displayProfiles();
            } else if (tabName === 'ratings') {
                loadRatings();
            } else if (tabName === 'analytics') {
                loadAnalytics();
            }
        }

        function updateVendorSubtypes() {
            const vendorType = document.getElementById('vendorType').value;
            const subtypeSelect = document.getElementById('vendorSubtype');
            
            // Clear existing options
            subtypeSelect.innerHTML = '<option value="">Select Specialization</option>';
            
            if (!vendorType) return;
            
            // Define subtypes for each vendor type
            const subtypes = {
                mechanical: [
                    'General Service', 'Engine Specialist', 'Transmission Expert',
                    'Electrical Specialist', 'AC Specialist', 'Brake Specialist',
                    'Suspension Expert', 'Diagnostic Specialist'
                ],
                bodyshop: [
                    'Paint & Body', 'Dent Removal', 'Collision Repair',
                    'Custom Paint', 'Glass Replacement'
                ],
                car_accessories: [
                    'Audio & Entertainment', 'Performance Parts', 'Interior Accessories',
                    'Exterior Accessories', 'Security Systems'
                ],
                wash_detailing: [
                    'Basic Wash', 'Premium Detailing', 'Paint Protection',
                    'Interior Deep Clean'
                ],
                insurance_agent: [
                    'Motor Insurance', 'Comprehensive Coverage', 'Third Party',
                    'Claims Assistance'
                ],
                rto_agent: [
                    'Registration', 'Transfer of Ownership', 'License Services',
                    'Permit Services'
                ],
                spare_parts: [
                    'Genuine Parts', 'Aftermarket Parts', 'Used Parts',
                    'Performance Parts'
                ],
                freelancer: [
                    'Mobile Mechanic', 'Specialist Consultant', 'Training & Education',
                    'Project Work'
                ]
            };
            
            if (subtypes[vendorType]) {
                subtypes[vendorType].forEach(subtype => {
                    const option = document.createElement('option');
                    option.value = subtype;
                    option.textContent = subtype;
                    subtypeSelect.appendChild(option);
                });
            }
        }

        function toggleWarrantyPeriod() {
            const warrantyOffered = document.getElementById('warrantyOffered').value;
            const warrantyPeriod = document.getElementById('warrantyPeriod');
            
            if (warrantyOffered === 'true') {
                warrantyPeriod.disabled = false;
                warrantyPeriod.required = true;
            } else {
                warrantyPeriod.disabled = true;
                warrantyPeriod.required = false;
                warrantyPeriod.value = '';
            }
        }

        // Load profiles from database
        async function loadProfiles() {
            try {
                console.log('Attempting to load profiles...');
                
                if (!window.supabaseClient) {
                    throw new Error('Supabase client not initialized');
                }
                
                // Add retry logic for network issues
                let retries = 3;
                let lastError;
                
                while (retries > 0) {
                    try {
                        const { data, error } = await window.supabaseClient
                            .from('garage_profiles')
                            .select('*')
                            .order('created_at', { ascending: false });

                        if (error) throw error;

                        console.log('Profiles loaded successfully:', data?.length || 0, 'profiles');
                        window.garageProfiles = data || [];
                        displayProfiles();
                        return; // Success, exit function
                        
                    } catch (error) {
                        lastError = error;
                        console.warn(`Attempt ${4 - retries} failed:`, error);
                        retries--;
                        
                        if (retries > 0) {
                            // Wait before retry
                            await new Promise(resolve => setTimeout(resolve, 1000));
                        }
                    }
                }
                
                // All retries failed
                throw lastError;
                
            } catch (error) {
                console.error('Load error:', error);
                
                // Show more specific error messages
                let errorMessage = 'Failed to load profiles';
                if (error.message.includes('Failed to fetch')) {
                    errorMessage = 'Network error. Please check your internet connection and try again.';
                } else if (error.message.includes('QUIC')) {
                    errorMessage = 'Connection error. Please refresh the page and try again.';
                } else {
                    errorMessage += `: ${error.message}`;
                }
                
                showError(errorMessage);
                
                // Show retry button
                const profilesList = document.getElementById('profilesList');
                if (profilesList) {
                    profilesList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-exclamation-triangle"></i>
                            <h3>Failed to Load Profiles</h3>
                            <p>${errorMessage}</p>
                            <button class="btn btn-primary" onclick="loadProfiles()">
                                <i class="fas fa-sync"></i> Try Again
                            </button>
                        </div>
                    `;
                }
            }
        }

        // Display profiles in the UI
        function displayProfiles() {
            const profilesList = document.getElementById('profilesList');
            
            if (!window.garageProfiles || window.garageProfiles.length === 0) {
                profilesList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-tools"></i>
                        <h3>No profiles found</h3>
                        <p>Start by adding your first garage or vendor profile</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            window.garageProfiles.forEach(profile => {
                html += createProfileCard(profile);
            });
            
            profilesList.innerHTML = html;
        }

        async function loadRatings() {
            try {
                const { data, error } = await window.supabaseClient
                    .from('garage_ratings')
                    .select(`
                        *,
                        garage_profiles(garage_name),
                        customers(full_name),
                        vehicles(registration_number)
                    `)
                    .order('review_date', { ascending: false });

                if (error) throw error;

                displayRatings(data || []);
                
            } catch (error) {
                console.error('Load ratings error:', error);
                showError('Failed to load ratings');
            }
        }

        // Display ratings
        function displayRatings(ratings) {
            const ratingsList = document.getElementById('ratingsList');
            
            if (ratings.length === 0) {
                ratingsList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-star"></i>
                        <h3>No ratings found</h3>
                        <p>Ratings will appear here when customers rate garage services</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            ratings.forEach(rating => {
                html += createRatingCard(rating);
            });
            
            ratingsList.innerHTML = html;
        }

        // Create rating card HTML
        function createRatingCard(rating) {
            const garageName = rating.garage_profiles?.garage_name || 'Unknown Garage';
            const customerName = rating.customers?.full_name || 'Anonymous';
            const vehicleNumber = rating.vehicles?.registration_number || 'N/A';
            
            return `
                <div class="rating-card">
                    <div class="rating-header">
                        <h4>${garageName}</h4>
                        <div class="rating-stars">
                            ${generateStarRating(rating.rating)}
                        </div>
                    </div>
                    <div class="rating-details">
                        <p><strong>Customer:</strong> ${customerName}</p>
                        <p><strong>Vehicle:</strong> ${vehicleNumber}</p>
                        <p><strong>Date:</strong> ${new Date(rating.review_date).toLocaleDateString()}</p>
                        ${rating.review_text ? `<p><strong>Review:</strong> ${rating.review_text}</p>` : ''}
                    </div>
                </div>
            `;
        }

        async function loadAnalytics() {
            try {
                const analyticsContent = document.getElementById('analyticsContent');
                
                // Get basic statistics from garage profiles
                const { data: profiles, error: profilesError } = await window.supabaseClient
                    .from('garage_profiles')
                    .select('vendor_type, overall_rating, total_ratings, total_interactions');

                if (profilesError) throw profilesError;

                // Get interactions data for key metrics
                const { data: interactions, error: interactionsError } = await window.supabaseClient
                    .from('interactions')
                    .select('interaction_status, total_amount, vendor_payment_status, created_at');

                if (interactionsError) throw interactionsError;

                // Get ratings data
                const { data: ratings, error: ratingsError } = await window.supabaseClient
                    .from('garage_ratings')
                    .select('rating, review_date');

                if (ratingsError) throw ratingsError;

                const analytics = calculateAnalytics(profiles || [], interactions || [], ratings || []);
                displayAnalytics(analytics);
                
            } catch (error) {
                console.error('Load analytics error:', error);
                showError('Failed to load analytics');
            }
        }

        // Calculate analytics
        function calculateAnalytics(profiles, interactions, ratings) {
            const totalProfiles = profiles.length;
            const vendorTypeCounts = {};
            const averageRating = profiles.reduce((sum, p) => sum + (p.overall_rating || 0), 0) / totalProfiles;
            const totalRatings = profiles.reduce((sum, p) => sum + (p.total_ratings || 0), 0);
            
            // Vendor type breakdown
            profiles.forEach(profile => {
                const type = profile.vendor_type;
                vendorTypeCounts[type] = (vendorTypeCounts[type] || 0) + 1;
            });

            // Interactions analysis
            const totalInteractions = interactions.length;
            const completedInteractions = interactions.filter(i => i.interaction_status === 'completed').length;
            const pendingInteractions = interactions.filter(i => i.interaction_status === 'pending').length;
            const totalRevenue = interactions.reduce((sum, i) => sum + (i.total_amount || 0), 0);
            const pendingPayments = interactions.filter(i => i.vendor_payment_status === 'pending').length;

            // Rating trends
            const recentRatings = ratings.filter(r => {
                const ratingDate = new Date(r.review_date);
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                return ratingDate >= thirtyDaysAgo;
            });

            const averageRecentRating = recentRatings.length > 0 
                ? recentRatings.reduce((sum, r) => sum + r.rating, 0) / recentRatings.length 
                : 0;
            
            return {
                totalProfiles,
                vendorTypeCounts,
                averageRating: averageRating || 0,
                totalRatings,
                totalInteractions,
                completedInteractions,
                pendingInteractions,
                totalRevenue,
                pendingPayments,
                averageRecentRating,
                recentRatingsCount: recentRatings.length
            };
        }

        // Display analytics
        function displayAnalytics(analytics) {
            const analyticsContent = document.getElementById('analyticsContent');
            
            analyticsContent.innerHTML = `
                <div class="analytics-grid">
                    <div class="analytics-card">
                        <h4><i class="fas fa-tools"></i> Total Profiles</h4>
                        <div class="analytics-number">${analytics.totalProfiles}</div>
                    </div>
                    <div class="analytics-card">
                        <h4><i class="fas fa-star"></i> Average Rating</h4>
                        <div class="analytics-number">${analytics.averageRating.toFixed(1)}</div>
                    </div>
                    <div class="analytics-card">
                        <h4><i class="fas fa-handshake"></i> Total Interactions</h4>
                        <div class="analytics-number">${analytics.totalInteractions}</div>
                    </div>
                    <div class="analytics-card">
                        <h4><i class="fas fa-check-circle"></i> Completed Jobs</h4>
                        <div class="analytics-number">${analytics.completedInteractions}</div>
                    </div>
                    <div class="analytics-card">
                        <h4><i class="fas fa-clock"></i> Pending Jobs</h4>
                        <div class="analytics-number">${analytics.pendingInteractions}</div>
                    </div>
                    <div class="analytics-card">
                        <h4><i class="fas fa-money-bill-wave"></i> Total Revenue</h4>
                        <div class="analytics-number">${analytics.totalRevenue.toLocaleString()}</div>
                    </div>
                    <div class="analytics-card">
                        <h4><i class="fas fa-exclamation-triangle"></i> Pending Payments</h4>
                        <div class="analytics-number">${analytics.pendingPayments}</div>
                    </div>
                    <div class="analytics-card">
                        <h4><i class="fas fa-chart-line"></i> Recent Rating (30d)</h4>
                        <div class="analytics-number">${analytics.averageRecentRating.toFixed(1)}</div>
                    </div>
                </div>
                
                <div class="vendor-type-breakdown">
                    <h4><i class="fas fa-chart-pie"></i> Vendor Type Breakdown</h4>
                    <div class="breakdown-chart">
                        ${Object.entries(analytics.vendorTypeCounts).map(([type, count]) => `
                            <div class="breakdown-item">
                                <span class="breakdown-label">${getVendorTypeLabel(type)}</span>
                                <span class="breakdown-count">${count}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <div class="interactions-summary">
                    <h4><i class="fas fa-list-alt"></i> Recent Activity Summary</h4>
                    <div class="summary-grid">
                        <div class="summary-item">
                            <div class="summary-label">Total Ratings</div>
                            <div class="summary-value">${analytics.totalRatings}</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Recent Ratings (30d)</div>
                            <div class="summary-value">${analytics.recentRatingsCount}</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Completion Rate</div>
                            <div class="summary-value">${analytics.totalInteractions > 0 ? ((analytics.completedInteractions / analytics.totalInteractions) * 100).toFixed(1) : 0}%</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function filterProfiles() {
            // TODO: Implement profile filtering
            console.log('Filtering profiles...');
        }

        function exportData() {
            // TODO: Implement data export
            console.log('Exporting data...');
        }

        function refreshProfiles() {
            loadProfiles();
        }

        // Create profile card HTML
        function createProfileCard(profile) {
            const vendorTypeLabel = getVendorTypeLabel(profile.vendor_type);
            const rating = profile.overall_rating || 0;
            const ratingCount = profile.total_ratings || 0;
            
            return `
                <div class="profile-card" data-profile-id="${profile.id}">
                    <div class="profile-header">
                        <div class="profile-name">
                            ${profile.garage_name}
                            <span class="vendor-badge">
                                <i class="fas ${getVendorTypeIcon(profile.vendor_type)}"></i>
                                ${vendorTypeLabel}
                            </span>
                        </div>
                        <div class="profile-actions">
                            <button class="btn btn-primary" onclick="editProfile('${profile.id}')">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="btn btn-danger" onclick="deleteProfile('${profile.id}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                    
                    <div class="profile-details">
                        <div class="detail-item">
                            <div class="detail-label">Location</div>
                            <div class="detail-value">${profile.location || 'Not specified'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Contact Person</div>
                            <div class="detail-value">${profile.contact_person || 'Not specified'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Phone</div>
                            <div class="detail-value">${profile.phone || 'Not specified'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Email</div>
                            <div class="detail-value">${profile.email || 'Not specified'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Specialization</div>
                            <div class="detail-value">${profile.vendor_subtype || 'Not specified'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Operating Hours</div>
                            <div class="detail-value">${profile.operating_hours || 'Not specified'}</div>
                        </div>
                    </div>
                    
                    <div class="rating-display">
                        <div class="rating-stars">
                            ${generateStarRating(rating)}
                        </div>
                        <div class="rating-number">${rating.toFixed(1)}</div>
                        <div class="rating-count">(${ratingCount} ratings)</div>
                    </div>
                    
                    ${profile.photos && profile.photos.length > 0 ? `
                        <div class="profile-photos">
                            <h4><i class="fas fa-camera"></i> Photos (${profile.photos.length})</h4>
                            <div class="photo-grid">
                                ${profile.photos.map(photo => `
                                    <img src="${photo}" alt="Profile photo" onclick="openPhotoModal('${photo}')">
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // Get vendor type label
        function getVendorTypeLabel(vendorType) {
            const labels = {
                mechanical: 'Mechanical Workshop',
                bodyshop: 'Bodyshop',
                car_accessories: 'Car Accessories',
                wash_detailing: 'Wash & Detailing',
                insurance_agent: 'Insurance Agent',
                rto_agent: 'RTO Agent',
                spare_parts: 'Spare Parts',
                freelancer: 'Freelancer'
            };
            
            return labels[vendorType] || vendorType;
        }

        // Get vendor type icon
        function getVendorTypeIcon(vendorType) {
            const icons = {
                mechanical: 'fa-tools',
                bodyshop: 'fa-car',
                car_accessories: 'fa-cog',
                wash_detailing: 'fa-soap',
                insurance_agent: 'fa-shield-alt',
                rto_agent: 'fa-id-card',
                spare_parts: 'fa-box',
                freelancer: 'fa-user-tie'
            };
            
            return icons[vendorType] || 'fa-building';
        }

        // Generate star rating HTML
        function generateStarRating(rating) {
            let stars = '';
            for (let i = 1; i <= 5; i++) {
                const starClass = i <= rating ? 'star filled' : 'star';
                stars += `<i class="fas fa-star ${starClass}"></i>`;
            }
            return stars;
        }

        // Handle form submission
        async function handleFormSubmission(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.innerHTML;
            
            try {
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                submitBtn.disabled = true;
                
                // Check if we're editing an existing profile
                if (window.currentProfile && window.currentProfile.id) {
                    console.log('Editing existing profile, calling updateProfile instead');
                    await updateProfile();
                    return;
                }
                
                const formData = new FormData(e.target);
                const profile = {};
                
                // Get form data
                for (let [key, value] of formData.entries()) {
                    profile[key] = value;
                }
                
                // Convert form data to database format
                const dbProfile = convertFormDataToProfile(profile);
                
                // Upload photos if any
                if (window.uploadedPhotos && window.uploadedPhotos.length > 0) {
                    console.log('Uploading photos...');
                    const photoUrls = await uploadPhotos();
                    dbProfile.photos = photoUrls;
                    console.log('Photos uploaded:', photoUrls);
                } else {
                    dbProfile.photos = [];
                }
                
                // Save to database
                const { data, error } = await window.supabaseClient
                    .from('garage_profiles')
                    .insert([dbProfile]);

                if (error) throw error;

                showSuccessMessage('Profile saved successfully!');
                resetForm();
                loadProfiles();
                
            } catch (error) {
                console.error('Save error:', error);
                showError(error.message || 'Failed to save profile');
            } finally {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }

        // Convert form data to database profile format
        function convertFormDataToProfile(formData) {
            const profile = {
                garage_name: formData.garageName,
                vendor_type: formData.vendorType,
                vendor_subtype: formData.vendorSubtype,
                contact_person: formData.contactPerson,
                location: formData.location,
                phone: formData.phone,
                email: formData.email,
                website: formData.website,
                operating_hours: formData.operatingHours,
                emergency_service: formData.emergencyService === 'true',
                home_service: formData.homeService === 'true',
                towing_service: formData.towingService === 'true',
                specializations: formData.specializations ? formData.specializations.split('\n').filter(s => s.trim()) : [],
                certifications: formData.certifications ? formData.certifications.split('\n').filter(s => s.trim()) : [],
                warranty_offered: formData.warrantyOffered === 'true',
                warranty_period: formData.warrantyPeriod || null,
                profile_visible: formData.profileVisible === 'true',
                featured_profile: formData.featuredProfile === 'true'
            };
            
            return profile;
        }

        // Edit profile
        async function editProfile(profileId) {
            try {
                const profile = window.garageProfiles.find(p => p.id === profileId);
                if (!profile) {
                    showError('Profile not found');
                    return;
                }
                
                window.currentProfile = profile;
                populateForm(profile);
                showTab('add');
                
            } catch (error) {
                console.error('Edit error:', error);
                showError('Failed to edit profile');
            }
        }

        // Delete profile
        async function deleteProfile(profileId) {
            if (!confirm('Are you sure you want to delete this profile? This action cannot be undone.')) {
                return;
            }
            
            try {
                const { error } = await window.supabaseClient
                    .from('garage_profiles')
                    .delete()
                    .eq('id', profileId);

                if (error) throw error;

                showSuccessMessage('Profile deleted successfully');
                loadProfiles();
                
            } catch (error) {
                console.error('Delete error:', error);
                showError('Failed to delete profile');
            }
        }

        // Populate form with profile data
        function populateForm(profile) {
            const form = document.getElementById('garageForm');
            
            // Basic information
            form.garageName.value = profile.garage_name || '';
            form.vendorType.value = profile.vendor_type || '';
            updateVendorSubtypes();
            form.vendorSubtype.value = profile.vendor_subtype || '';
            form.contactPerson.value = profile.contact_person || '';
            form.location.value = profile.location || '';
            form.phone.value = profile.phone || '';
            form.email.value = profile.email || '';
            form.website.value = profile.website || '';
            
            // Business hours & operations
            form.operatingHours.value = profile.operating_hours || '';
            form.emergencyService.value = profile.emergency_service || 'false';
            form.homeService.value = profile.home_service || 'false';
            form.towingService.value = profile.towing_service || 'false';
            
            // Services & specializations
            form.specializations.value = profile.specializations ? profile.specializations.join('\n') : '';
            form.certifications.value = profile.certifications ? profile.certifications.join('\n') : '';
            form.warrantyOffered.value = profile.warranty_offered || 'false';
            form.warrantyPeriod.value = profile.warranty_period || '';
            toggleWarrantyPeriod();
            
            // Profile visibility settings
            if (form.profileVisible) {
                form.profileVisible.value = profile.profile_visible !== false ? 'true' : 'false';
            }
            if (form.featuredProfile) {
                form.featuredProfile.value = profile.featured_profile || 'false';
            }
            
            // Handle existing photos
            if (profile.photos && profile.photos.length > 0) {
                displayExistingPhotos(profile.photos);
                // Store existing photos for reference
                window.existingPhotos = profile.photos;
                
                // Initialize uploadedPhotos as empty for new uploads only
                // Existing photos are handled separately in displayExistingPhotos
                window.uploadedPhotos = [];
            } else {
                hideExistingPhotos();
                window.existingPhotos = [];
                window.uploadedPhotos = [];
            }
            
            // Don't call updatePhotoPreview here - it's only for new uploads
            
            // Update submit button
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.innerHTML = '<i class="fas fa-save"></i> Update Profile';
            submitBtn.onclick = updateProfile;
        }

        // Update profile
        async function updateProfile() {
            console.log('updateProfile called');
            console.log('currentProfile:', window.currentProfile);
            
            if (!window.currentProfile) {
                showError('No profile selected for update');
                return;
            }
            
            try {
                const formData = new FormData(document.getElementById('garageForm'));
                const profile = convertFormDataToProfile(Object.fromEntries(formData));
                
                console.log('Form data converted to profile:', profile);
                
                // Handle photos for update - PRESERVE existing photos
                let finalPhotos = [];
                
                // Start with existing photos from window.existingPhotos (which tracks removals)
                if (window.existingPhotos && window.existingPhotos.length > 0) {
                    finalPhotos = [...window.existingPhotos];
                    console.log('Preserving existing photos:', finalPhotos.length);
                }
                
                // Add new photos if any
                if (window.uploadedPhotos && window.uploadedPhotos.length > 0) {
                    // Only process photos that have actual files (new uploads)
                    const newPhotos = window.uploadedPhotos.filter(photo => photo.file);
                    
                    console.log('New photos to upload:', newPhotos.length);
                    
                    if (newPhotos.length > 0) {
                        console.log('Uploading new photos for update...');
                        const photoUrls = await uploadPhotos();
                        // Add new photos to existing ones
                        finalPhotos = [...finalPhotos, ...photoUrls];
                        console.log('Total photos after adding new ones:', finalPhotos.length);
                    }
                }
                
                // Set the final photo array
                profile.photos = finalPhotos;
                
                console.log('Final photo count for update:', profile.photos.length);
                
                // Check if photos array is too large and prevent update if so
                const totalPhotoSize = JSON.stringify(profile.photos).length;
                const maxSize = 2 * 1024 * 1024; // 2MB limit for compressed photos
                
                if (totalPhotoSize > maxSize) {
                    const sizeMB = (totalPhotoSize / 1024 / 1024).toFixed(1);
                    console.error(`Photo data size (${sizeMB}MB) is too large for database update`);
                    
                    // Show error and prevent update
                    showError(`Photo data too large (${sizeMB}MB). Photos will be compressed further or you can use smaller photos.`);
                    throw new Error(`Photo data size ${sizeMB}MB exceeds 2MB limit`);
                }
                
                console.log(`Photo data size: ${(totalPhotoSize / 1024).toFixed(1)}KB - OK for database update`);
                
                console.log('Profile to update (photos only):', {
                    photoCount: profile.photos.length,
                    totalSize: `${(totalPhotoSize / 1024).toFixed(1)}KB`
                });
                
                // Update in database with timeout handling
                console.log('Updating profile in database...');
                
                // Only update changed fields to reduce data size
                const updateData = {
                    ...profile,
                    updated_at: new Date().toISOString()
                };
                
                // Remove any undefined or null values that might cause issues
                Object.keys(updateData).forEach(key => {
                    if (updateData[key] === undefined || updateData[key] === null) {
                        delete updateData[key];
                    }
                });
                
                console.log('Update data (cleaned):', updateData);
                
                // Try to update with retry mechanism
                let retries = 3;
                let lastError;
                
                while (retries > 0) {
                    try {
                        const { error } = await window.supabaseClient
                            .from('garage_profiles')
                            .update(updateData)
                            .eq('id', window.currentProfile.id)
                            .select('id'); // Only return the ID to minimize data transfer

                        if (error) throw error;
                        
                        console.log('Profile updated successfully on attempt', 4 - retries);
                        break; // Success, exit retry loop
                        
                    } catch (error) {
                        lastError = error;
                        retries--;
                        console.warn(`Update attempt ${4 - retries} failed:`, error);
                        
                        if (retries > 0) {
                            // Wait before retry
                            await new Promise(resolve => setTimeout(resolve, 1000));
                        }
                    }
                }
                
                if (retries === 0) {
                    // If all retries failed, try a fallback approach
                    console.log('All retries failed, trying fallback update method...');
                    
                    try {
                        // Try updating without photos first
                        const { error: photoError } = await window.supabaseClient
                            .from('garage_profiles')
                            .update({
                                ...updateData,
                                photos: [] // Temporarily clear photos
                            })
                            .eq('id', window.currentProfile.id)
                            .select('id');
                        
                        if (photoError) throw photoError;
                        
                        // Then update just the photos
                        const { error: photosError } = await window.supabaseClient
                            .from('garage_profiles')
                            .update({
                                photos: updateData.photos
                            })
                            .eq('id', window.currentProfile.id)
                            .select('id');
                        
                        if (photosError) throw photosError;
                        
                        console.log('Fallback update successful');
                        
                    } catch (fallbackError) {
                        console.error('Fallback update also failed:', fallbackError);
                        throw fallbackError;
                    }
                }

                showSuccessMessage('Profile updated successfully!');
                resetForm();
                loadProfiles();
                window.currentProfile = null;
                
            } catch (error) {
                console.error('Update error:', error);
                showError(error.message || 'Failed to update profile');
            }
        }

        // Filter profiles
        function filterProfiles() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filteredProfiles = window.garageProfiles.filter(profile => 
                profile.garage_name.toLowerCase().includes(searchTerm) ||
                (profile.location && profile.location.toLowerCase().includes(searchTerm)) ||
                (profile.vendor_type && profile.vendor_type.toLowerCase().includes(searchTerm))
            );
            
            displayFilteredProfiles(filteredProfiles);
        }

        // Display filtered profiles
        function displayFilteredProfiles(profiles) {
            const profilesList = document.getElementById('profilesList');
            
            if (profiles.length === 0) {
                profilesList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-search"></i>
                        <h3>No matching profiles</h3>
                        <p>Try adjusting your search terms</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            profiles.forEach(profile => {
                html += createProfileCard(profile);
            });
            
            profilesList.innerHTML = html;
        }

        // Export data
        function exportData() {
            const dataStr = JSON.stringify(window.garageProfiles, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `garage_profiles_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }

        function resetForm() {
            document.getElementById('garageForm').reset();
            
            // Clear photos
            if (window.uploadedPhotos) {
                window.uploadedPhotos = [];
                updatePhotoPreview();
            }
            
            // Hide existing photos section
            hideExistingPhotos();
            window.existingPhotos = [];
            
            // Hide new photos section
            const newPhotosSection = document.getElementById('newPhotosSection');
            if (newPhotosSection) {
                newPhotosSection.style.display = 'none';
            }
            
            updateVendorSubtypes();
            toggleWarrantyPeriod();
            
            // Reset submit button
            const submitBtn = document.getElementById('submitBtn');
            if (submitBtn) {
                submitBtn.innerHTML = '<i class="fas fa-save"></i> Save Profile';
                submitBtn.onclick = null;
            }
            
            window.currentProfile = null;
        }

        function initializePhotoUpload() {
            const photoUpload = document.getElementById('photoUpload');
            const photoInput = document.getElementById('photoInput');

            // Drag and drop functionality
            photoUpload.addEventListener('dragover', (e) => {
                e.preventDefault();
                photoUpload.classList.add('dragover');
            });

            photoUpload.addEventListener('dragleave', () => {
                photoUpload.classList.remove('dragover');
            });

            photoUpload.addEventListener('drop', (e) => {
                e.preventDefault();
                photoUpload.classList.remove('dragover');
                const files = Array.from(e.dataTransfer.files);
                handlePhotoFiles(files);
            });

            // File input change
            photoInput.addEventListener('change', (e) => {
                const files = Array.from(e.target.files);
                handlePhotoFiles(files);
                // Clear the input to allow selecting the same file again
                e.target.value = '';
            });
        }

        function handlePhotoFiles(files) {
            console.log('handlePhotoFiles called with:', files);
            console.log('Current uploadedPhotos:', window.uploadedPhotos);
            
            // Clear existing photos to prevent duplicates
            if (!window.uploadedPhotos) window.uploadedPhotos = [];
            
            files.forEach(file => {
                console.log('Processing file:', file.name, file.type, file.size);
                
                // Check file size (max 10MB, but warn if over 5MB)
                const maxSize = 10 * 1024 * 1024; // 10MB
                const warningSize = 5 * 1024 * 1024; // 5MB
                
                if (file.type.startsWith('image/') && file.size <= maxSize) {
                    // Warn if file is large
                    if (file.size > warningSize) {
                        console.warn(`Large file detected: ${(file.size / 1024 / 1024).toFixed(1)}MB - will be compressed`);
                        showError(`Large file detected: ${(file.name)} (${(file.size / 1024 / 1024).toFixed(1)}MB). File will be compressed to reduce size.`);
                    }
                    
                    // Check if file is already uploaded (only check against actual file objects)
                    const isDuplicate = window.uploadedPhotos.some(photo => {
                        if (!photo.file) {
                            console.log('Photo has no file property:', photo);
                            return false;
                        }
                        return photo.file.name === file.name && photo.file.size === file.size;
                    });
                    
                    if (!isDuplicate) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const newPhoto = {
                                file: file,
                                preview: e.target.result,
                                isNew: true
                            };
                            window.uploadedPhotos.push(newPhoto);
                            console.log('Added new photo:', newPhoto);
                            updatePhotoPreview();
                        };
                        reader.readAsDataURL(file);
                    } else {
                        console.log('Duplicate file skipped:', file.name);
                    }
                } else {
                    showError(`File too large: ${file.name} (${(file.size / 1024 / 1024).toFixed(1)}MB). Maximum size is 10MB.`);
                }
            });
        }

        // Upload photos to Supabase storage with compression
        async function uploadPhotos() {
            const photoUrls = [];
            
            for (const photo of window.uploadedPhotos) {
                try {
                    // Skip if no file (existing photos)
                    if (!photo.file) {
                        if (photo.preview) {
                            photoUrls.push(photo.preview);
                        }
                        continue;
                    }
                    
                    const fileName = `garage_photos/${Date.now()}_${Math.random().toString(36).substring(7)}.jpg`;
                    
                    console.log('Attempting to upload:', fileName);
                    
                    // Try to upload to Supabase storage
                    const { data, error } = await window.supabaseClient.storage
                        .from('garage-photos')
                        .upload(fileName, photo.file, {
                            cacheControl: '3600',
                            upsert: false
                        });

                    if (error) {
                        console.error('Storage upload failed:', error);
                        
                        // Since user prefers database storage, compress and use base64 fallback
                        console.log('Storage failed, using compressed base64 fallback for database storage');
                        const compressedPhoto = await compressPhoto(photo.file);
                        photoUrls.push(compressedPhoto);
                        continue;
                    }

                    const { data: { publicUrl } } = window.supabaseClient.storage
                        .from('garage-photos')
                        .getPublicUrl(fileName);

                    photoUrls.push(publicUrl);
                    console.log('Photo uploaded successfully:', publicUrl);
                } catch (error) {
                    console.error('Photo upload error:', error);
                    
                    // Since user prefers database storage, compress and use base64 fallback
                    console.log('Photo upload error, using compressed base64 fallback for database storage');
                    const compressedPhoto = await compressPhoto(photo.file);
                    photoUrls.push(compressedPhoto);
                }
            }

            return photoUrls;
        }

        // Compress photo to reduce size - AGGRESSIVE compression for database storage
        async function compressPhoto(file) {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = () => {
                    // AGGRESSIVE compression: max 400x300 for database storage
                    const maxWidth = 400;
                    const maxHeight = 300;
                    let { width, height } = img;
                    
                    if (width > height) {
                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        }
                    } else {
                        if (height > maxHeight) {
                            width = (width * maxHeight) / height;
                            height = maxHeight;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    // Draw and compress with LOW quality for database storage
                    ctx.drawImage(img, 0, 0, width, height);
                    const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.5); // 50% quality for database
                    
                    const sizeKB = (compressedDataUrl.length / 1024).toFixed(1);
                    console.log(`Photo aggressively compressed: ${sizeKB}KB (${width}x${height})`);
                    
                    // Warn if still too large
                    if (compressedDataUrl.length > 500 * 1024) { // 500KB limit
                        console.warn(` Photo still large: ${sizeKB}KB - may cause database issues`);
                    }
                    
                    resolve(compressedDataUrl);
                };
                
                img.src = URL.createObjectURL(file);
            });
        }

        // Update photo preview - ONLY for new photos, not existing ones
        function updatePhotoPreview() {
            console.log('updatePhotoPreview called');
            console.log('uploadedPhotos:', window.uploadedPhotos);
            
            const preview = document.getElementById('photoPreview');
            const newPhotosSection = document.getElementById('newPhotosSection');
            
            if (!preview || !newPhotosSection) {
                console.log('Preview elements not found');
                return;
            }
            
            preview.innerHTML = '';

            if (!window.uploadedPhotos || window.uploadedPhotos.length === 0) {
                newPhotosSection.style.display = 'none';
                console.log('No photos to display');
                return;
            }

            // Show new photos section
            newPhotosSection.style.display = 'block';
            console.log('Displaying photos section');

                        // Filter out existing photos - this function should only show new uploads
            const newPhotosOnly = window.uploadedPhotos.filter(photo => photo.isNew);
            console.log('Filtered to show only new photos:', newPhotosOnly.length);
            
            if (newPhotosOnly.length === 0) {
                newPhotosSection.style.display = 'none';
                console.log('No new photos to display');
                return;
            }
            
            newPhotosOnly.forEach((photo, displayIndex) => {
                console.log(`Processing new photo ${displayIndex}:`, photo);
                
                const photoItem = document.createElement('div');
                photoItem.className = 'photo-item';
                
                // Find the actual index in the original uploadedPhotos array
                const actualIndex = window.uploadedPhotos.findIndex(p => p === photo);
                
                photoItem.innerHTML = `
                    <img src="${photo.preview}" alt="New Photo">
                    <button class="photo-remove" onclick="removePhoto(${actualIndex})" title="Remove new photo">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                preview.appendChild(photoItem);
            });
        }

        // Remove photo
        function removePhoto(index) {
            console.log('removePhoto called with index:', index);
            if (window.uploadedPhotos && window.uploadedPhotos[index]) {
                console.log('Removing photo at index:', index);
                window.uploadedPhotos.splice(index, 1);
                updatePhotoPreview();
            } else {
                console.log('Photo not found at index:', index);
            }
        }

        // Remove existing photo
        function removeExistingPhoto(index) {
            if (window.uploadedPhotos && window.uploadedPhotos[index]) {
                const photo = window.uploadedPhotos[index];
                if (photo.isExisting) {
                    // Mark as removed but keep in array for now
                    photo.removed = true;
                    console.log('Marked existing photo for removal:', photo.preview);
                    // Update the preview to show the removed state
                    updatePhotoPreview();
                }
            }
        }

        // Open photo modal
        function openPhotoModal(photoUrl) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.9);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
                cursor: pointer;
            `;
            
            const img = document.createElement('img');
            img.src = photoUrl;
            img.style.cssText = `
                max-width: 90%;
                max-height: 90%;
                object-fit: contain;
                border-radius: 8px;
            `;
            
            modal.appendChild(img);
            document.body.appendChild(modal);
            
            modal.addEventListener('click', () => {
                document.body.removeChild(modal);
            });
        }

        // Show success message
        function showSuccessMessage(message) {
            // Create or update success message element
            let successElement = document.getElementById('successMessage');
            if (!successElement) {
                successElement = document.createElement('div');
                successElement.id = 'successMessage';
                successElement.className = 'success-message';
                successElement.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    z-index: 1000;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                `;
                document.body.appendChild(successElement);
            }
            
            successElement.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
            successElement.style.display = 'block';
            
            setTimeout(() => {
                successElement.style.display = 'none';
            }, 5000);
        }

        // Display existing photos in edit mode
        function displayExistingPhotos(photos) {
            console.log('displayExistingPhotos called with:', photos);
            const existingSection = document.getElementById('existingPhotosSection');
            const existingGrid = document.getElementById('existingPhotosGrid');
            
            if (!existingSection || !existingGrid) {
                console.log('Existing photos elements not found');
                return;
            }
            
            existingSection.style.display = 'block';
            existingGrid.innerHTML = '';
            
            console.log('Displaying', photos.length, 'existing photos');
            
            photos.forEach((photo, index) => {
                const photoItem = document.createElement('div');
                photoItem.className = 'existing-photo-item';
                photoItem.innerHTML = `
                    <img src="${photo}" alt="Existing photo" onclick="openPhotoModal('${photo}')">
                    <button class="existing-photo-remove" onclick="removeExistingPhotoFromSection(${index})" title="Delete this photo">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                existingGrid.appendChild(photoItem);
            });
        }

        // Hide existing photos section
        function hideExistingPhotos() {
            const existingSection = document.getElementById('existingPhotosSection');
            if (existingSection) {
                existingSection.style.display = 'none';
            }
        }

        // Remove existing photo from the separate existing photos section
        function removeExistingPhotoFromSection(index) {
            if (!window.existingPhotos) return;
            
            if (confirm('Are you sure you want to delete this photo? This action cannot be undone.')) {
                window.existingPhotos.splice(index, 1);
                displayExistingPhotos(window.existingPhotos);
                
                // Show message
                showSuccessMessage('Photo removed. Click Update Profile to save changes.');
            }
        }

        // Show error message
        function showError(message) {
            // Create or update error message element
            let errorElement = document.getElementById('errorMessage');
            if (!errorElement) {
                errorElement = document.createElement('div');
                errorElement.id = 'errorMessage';
                errorElement.className = 'error-message';
                errorElement.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    z-index: 1000;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                `;
                document.body.appendChild(errorElement);
            }
            
            errorElement.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
            errorElement.style.display = 'block';
            
            setTimeout(() => {
                errorElement.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>
